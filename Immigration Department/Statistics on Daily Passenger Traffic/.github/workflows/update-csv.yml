name: æ¯æ—¥è‡ªå‹•æ›´æ–°å‡ºå…¥å¢ƒ CSV
on:
  schedule:
    - cron: '0 2 * * *'  # æ¯æ—¥ HKT 10:00 è‡ªå‹•åŸ·è¡Œ
  workflow_dispatch:     # æ‰‹å‹•æ¸¬è©¦æŒ‰éˆ•

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    - name: æª¢æŸ¥å‡ºè³‡æ–™å¤¾
      run: mkdir -p "0Data/Immigration Department/Statistics on Daily Passenger Traffic/data"
    
    - name: ä¸‹è¼‰æœ€æ–° CSV
      run: |
        curl -L -o "0Data/Immigration Department/Statistics on Daily Passenger Traffic/data/immigration.csv" \
        "https://www.immd.gov.hk/opendata/eng/transport/immigration_clearance/statistics_on_daily_passenger_traffic.csv"
    
    - name: æª¢æŸ¥æ˜¯å¦æœ‰æ›´æ–°
      id: diff
      run: |
        if [ ! -f "0Data/Immigration Department/Statistics on Daily Passenger Traffic/data/immigration.csv.old" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        elif ! git diff --quiet "0Data/Immigration Department/Statistics on Daily Passenger Traffic/data/immigration.csv"; then
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
    
    - name: å‚™ä»½èˆŠæª”æ¡ˆä¸¦æäº¤æ›´æ–°
      if: steps.diff.outputs.changed == 'true'
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        cp "0Data/Immigration Department/Statistics on Daily Passenger Traffic/data/immigration.csv" \
           "0Data/Immigration Department/Statistics on Daily Passenger Traffic/data/immigration.csv.old"
        git add "0Data/Immigration Department/Statistics on Daily Passenger Traffic/data/immigration.csv"
        git commit -m "ğŸ“Š è‡ªå‹•æ›´æ–°å‡ºå…¥å¢ƒ CSV $(date +'%Y-%m-%d %H:%M')"
        git push
