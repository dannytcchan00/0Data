<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hong Kong Live Dashboard</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0f0f23, #1a1a2e); color: #e0e0e0; min-height: 100vh; padding: 2rem 0;}
    .row1 { display: grid; grid-template-columns: 20% 80%; gap: 1.5rem; max-width: 1400px; margin: 0 auto 1.5rem auto; padding: 0 2rem; height: 420px;}
    /* üî• Á¨¨‰∫åË°å‰∏âÊ¨ÑÔºöÊî∂Ë≤ª33% + ËªäÈÄü33% + ‰∫§ÈÄö33% */
    .row2 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; max-width: 1400px; margin: 0 auto; padding: 0 2rem; height: 380px;}
    
    .weather-hero {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 24px; padding: 1.8rem 1.5rem; box-shadow: 0 12px 40px rgba(102,126,234,0.4); display: flex; flex-direction: column; justify-content: center; text-align: center; position: relative; overflow: hidden; width: 100%; min-height: 0;}
    .weather-hero::before {content: 'üå§Ô∏è'; font-size: 3.5rem; position: absolute; top: 10px; right: 10px; opacity: 0.2;}
    
    /* üî• ‰∏âÊ¨ÑÁõ¥ÂºèÊ®£Âºè */
    .tunnel-tolls {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 24px;}
    .tunnel-speeds {background: linear-gradient(135deg, #4caf50, #66bb6a); border-radius: 24px;}
    .traffic-news {background: linear-gradient(135deg, #ff6b6b, #ff8e53); border-radius: 24px;}
    
    .panel-header {color: #ffffff; font-size: 0.95rem; font-weight: 700; padding: 1rem 1rem 0.8rem 1rem; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.2);}
    .panel-content {padding: 0.8rem 1rem 1rem; overflow-y: auto; height: calc(100% - 3.5rem); font-size: 0.75rem; line-height: 1.3;}
    
    /* ÈößÈÅìÊî∂Ë≤ªÁõ¥Âºè */
    .toll-group {margin-bottom: 0.8rem;}
    .toll-name {font-weight: 700; font-size: 0.78rem; color: #ffffff; margin-bottom: 0.4rem; padding-bottom: 0.2rem; border-bottom: 1px solid rgba(255,255,255,0.3);}
    .toll-item {display: flex; justify-content: space-between; align-items: center; padding: 0.3rem 0; font-size: 0.7rem;}
    .vehicle-type {font-weight: 500; min-width: 2.8rem;}
    .toll-fee {background: rgba(255,255,255,0.25); color: #fff; padding: 0.2rem 0.5rem; border-radius: 8px; font-weight: 700; font-size: 0.75rem; min-width: 3rem; text-align: center;}
    .peak-status {font-size: 0.65rem; color: rgba(255,255,255,0.7); text-align: center; margin-top: 0.4rem; padding-top: 0.4rem; border-top: 1px solid rgba(255,255,255,0.1);}
    
    /* ÈößÈÅìËªäÈÄüÁõ¥Âºè */
    .speed-group {margin-bottom: 0.9rem;}
    .speed-name {font-weight: 700; font-size: 0.78rem; color: #ffffff; margin-bottom: 0.4rem; padding-bottom: 0.2rem; border-bottom: 1px solid rgba(255,255,255,0.3); text-align: center;}
    .speed-item {display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0.3rem; background: rgba(255,255,255,0.1); margin: 0.2rem 0; border-radius: 8px;}
    .speed-dir {font-weight: 600; font-size: 0.68rem;}
    .speed-val {font-weight: 700; font-size: 0.8rem; padding: 0.2rem 0.6rem; border-radius: 12px; min-width: 3.5rem; text-align: center;}
    .speed-good {background: rgba(255,255,255,0.3); color: #4caf50;}
    .speed-slow {background: rgba(255,193,7,0.3); color: #ff9800;}
    .speed-congested {background: rgba(244,67,54,0.3); color: #f44336;}
    
    /* ‰∫§ÈÄöÊ∂àÊÅØÁõ¥Âºè */
    .traffic-item {padding: 0.6rem 0; border-bottom: 1px solid rgba(255,255,255,0.15); display: flex; align-items: flex-start; gap: 0.4rem;}
    .traffic-icon {font-size: 1rem; min-width: 1.2rem; flex-shrink: 0; margin-top: 0.1rem;}
    .traffic-text {flex: 1; font-size: 0.7rem; line-height: 1.3;}
    .traffic-title {font-weight: 600; margin-bottom: 0.1rem;}
    .traffic-time {color: rgba(255,255,255,0.8); font-size: 0.65rem;}
    
    .news-hero {background: rgba(30,30,30,0.9); border-radius: 24px; padding: 1.8rem 2rem; box-shadow: 0 12px 40px rgba(0,0,0,0.5); overflow-y: auto; backdrop-filter: blur(10px); min-height: 0; display: flex; flex-direction: column; font-size: 0.85rem; line-height: 1.3;}
    .hero-title {color: #ffffff; font-size: 1.2rem; font-weight: 700; margin-bottom: 0.8rem;}
    .weather-temp {font-size: 3.8rem; font-weight: 300; color: #ffffff; margin-bottom: 0.5rem; letter-spacing: -2px;}
    .weather-desc {font-size: 1.3rem; color: #e8f4fd; margin-bottom: 0.8rem; font-weight: 500;}
    .weather-details {font-size: 1rem; color: #b3d9ff;}
    .weather-warning {background: linear-gradient(45deg, #ff6b6b, #ff8e53); color: white; padding: 0.6rem 1.2rem; border-radius: 20px; font-weight: 600; margin-top: 0.8rem; font-size: 0.85rem;}
    .weather-icon {font-size: 2.5rem; margin-bottom: 0.3rem;}
    .news-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.3rem;}
    .news-item {padding: 1.1rem 0; border-bottom: 1px solid #444; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: flex-start; gap: 0.9rem; position: relative;}
    .news-item:hover {background: rgba(76,175,80,0.15); border-radius: 16px; padding: 1.1rem 1.5rem 1.1rem 2rem; transform: translateX(5px); border-left: 4px solid #4caf50; box-shadow: 0 4px 15px rgba(76,175,80,0.2);}
    .news-content {flex: 1;}
    .news-title {color: #ffffff; font-weight: 600; font-size: 0.95rem; line-height: 1.3; margin-bottom: 0.25rem;}
    .news-source {color: #ff6b6b; font-size: 0.8rem; font-weight: 700;}
    .news-time {color: #888; font-size: 0.7rem; margin-top: 0.15rem;}
    .news-badge {background: #4caf50; color: white; padding: 0.15rem 0.5rem; border-radius: 12px; font-size: 0.65rem; font-weight: 700; align-self: flex-start; margin-left: 0.5rem; line-height: 1; margin-top: 0.3rem;}
    .loading, .no-data {color: #888; text-align: center; padding: 2rem; font-style: italic;}
    .error {color: #ff6b6b; text-align: center; padding: 2rem; font-weight: 500;}
    .modal {display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(8px);}
    .modal-content {background: linear-gradient(135deg, #1e1e1e, #2a2a2e); margin: 2% auto; padding: 2.5rem 3rem; border-radius: 24px; width: 90%; max-width: 800px; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0,0,0,0.9); position: relative;}
    .modal-header {display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;}
    .close {color: #aaa; font-size: 2.5rem; font-weight: bold; cursor: pointer; line-height: 1; user-select: none;}
    .close:hover {color: #ffffff;}
    .modal-title {color: #ffffff; font-size: 1.4rem; font-weight: 700; margin: 0; flex: 1; margin-right: 1rem;}
    .modal-source {color: #ff6b6b; font-size: 0.95rem; font-weight: 700; margin-top: 0.3rem;}
    .modal-time {color: #888; font-size: 0.85rem; margin-top: 0.2rem;}
    .modal-description {color: #e0e0e0; line-height: 1.5; font-size: 1rem; margin-top: 1.5rem; white-space: pre-wrap;}
    @media (max-width: 1200px) { .row1 { grid-template-columns: 1fr; height: auto; } .row2 { grid-template-columns: 1fr; height: auto; gap: 1rem; } .news-hero { font-size: 0.8rem; }}
</style>
</head>
<body>
<section class="row1">
    <div class="weather-hero">
        <div class="hero-title">OpenWeatherMap</div>
        <div class="weather-icon" id="weatherIcon">üå§Ô∏è</div>
        <div class="weather-temp" id="weatherTemp">--¬∞C</div>
        <div class="weather-desc" id="weatherDesc">--</div>
        <div class="weather-details" id="weatherDetails">Hong Kong</div>
        <div id="weatherWarning"></div>
    </div>
    <div class="news-hero">
        <div class="news-header">
            <div class="hero-title">Hong Kong News</div>
            <span id="newsCount">(0)</span>
        </div>
        <div id="heroNews"><div class="loading">Loading latest news...</div></div>
    </div>
</section>

<!-- üî• Á¨¨‰∫åË°å‰∏âÊ¨ÑÁõ¥ÂºèÔºö1.Êî∂Ë≤ª 2.ËªäÈÄü 3.‰∫§ÈÄö -->
<section class="row2">
    <!-- 1Ô∏è‚É£ ÈößÈÅìÊî∂Ë≤ª (33%) -->
    <div class="tunnel-tolls">
        <div class="panel-header">üõ§Ô∏è Tunnel Tolls</div>
        <div class="panel-content" id="tunnelFees">
            <div class="no-data">Loading tolls...</div>
        </div>
    </div>
    
    <!-- 2Ô∏è‚É£ ÈößÈÅìËªäÈÄü (33%) -->
    <div class="tunnel-speeds">
        <div class="panel-header">üöó Tunnel Speeds</div>
        <div class="panel-content" id="tunnelFlow">
            <div class="no-data">Loading speeds...</div>
        </div>
    </div>
    
    <!-- 3Ô∏è‚É£ ‰∫§ÈÄöÊ∂àÊÅØ (33%) -->
    <div class="traffic-news">
        <div class="panel-header">üö® Traffic News</div>
        <div class="panel-content" id="trafficNews">
            <div class="no-data">Loading traffic...</div>
        </div>
    </div>
</section>

<div id="newsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div>
                <h2 class="modal-title" id="modalTitle">Loading...</h2>
                <div class="modal-source" id="modalSource"></div>
                <div class="modal-time" id="modalTime"></div>
            </div>
            <span class="close" id="modalClose">&times;</span>
        </div>
        <div class="modal-description" id="modalDescription"></div>
    </div>
</div>

<script>
const OW_API_KEY = 'f19c9c1cfbb572c048a0a99c38f012d2';
let newsData = [];

// km/h ËΩâ mph
function kmhToMph(kmh) { return Math.round(kmh * 0.621371); }

// 1Ô∏è‚É£ ÈößÈÅìÊî∂Ë≤ªÁõ¥Âºè
async function updateTunnelTolls() {
    const container = document.getElementById('tunnelFees');
    const now = new Date();
    const isWeekday = now.getDay() !== 0 && now.getDay() !== 6;
    const hour = now.getHours();
    const minute = now.getMinutes();
    const isPeak = isWeekday && ((hour >= 7 && hour < 10) || (hour === 10 && minute <= 15) || (hour >= 16 && hour < 19));
    
    const tolls = {
        'CHT': {private: isPeak ? 45 : 25, bus: isPeak ? 60 : 40, goods: isPeak ? 55 : 35},
        'WHC': {private: isPeak ? 70 : 50, bus: isPeak ? 90 : 70, goods: isPeak ? 80 : 60},
        'EHC': {private: isPeak ? 45 : 25, bus: isPeak ? 60 : 40, goods: isPeak ? 55 : 35}
    };
    
    let html = `<div class="peak-status">${isPeak ? 'üî¥ Peak' : 'üü¢ Off-Peak'}</div>`;
    for (const [tunnel, fees] of Object.entries(tolls)) {
        html += `
            <div class="toll-group">
                <div class="toll-name">${tunnel}</div>
                <div class="toll-item"><span class="vehicle-type">üöóCar</span><span class="toll-fee">$${fees.private}</span></div>
                <div class="toll-item"><span class="vehicle-type">üöåBus</span><span class="toll-fee">$${fees.bus}</span></div>
                <div class="toll-item"><span class="vehicle-type">üöõTruck</span><span class="toll-fee">$${fees.goods}</span></div>
            </div>
        `;
    }
    container.innerHTML = html;
}

// 2Ô∏è‚É£ ÈößÈÅìËªäÈÄüÁõ¥ÂºèÔºàËã±ÈáåÔºâ
async function updateTunnelFlow() {
    const flowContainer = document.getElementById('tunnelFlow');
    const now = new Date();
    
    try {
        const response = await fetch('https://resource.data.one.gov.hk/td/traffic-speed-map/en/tunnels.json');
        const data = await response.json();
        
        const tunnels = {
            'CHT': {klnToHK: kmhToMph(data?.cht?.klnToHk?.speed || 45), hkToKln: kmhToMph(data?.cht?.hkToKln?.speed || 45)},
            'WHC': {klnToHK: kmhToMph(data?.whc?.klnToHk?.speed || 50), hkToKln: kmhToMph(data?.whc?.hkToKln?.speed || 50)},
            'EHC': {klnToHK: kmhToMph(data?.ehc?.klnToHk?.speed || 55), hkToKln: kmhToMph(data?.ehc?.hkToKln?.speed || 55)}
        };
        
        let html = '';
        for (const [key, tunnel] of Object.entries(tunnels)) {
            const speedKlnToHK = tunnel.klnToHK;
            const speedHkToKln = tunnel.hkToKln;
            const getSpeedClass = (mph) => mph >= 31 ? 'speed-good' : mph >= 19 ? 'speed-slow' : 'speed-congested';
            
            html += `
                <div class="speed-group">
                    <div class="speed-name">${key}</div>
                    <div class="speed-item">
                        <span class="speed-dir">‚û°Ô∏è K‚ÜíHK</span>
                        <span class="speed-val ${getSpeedClass(speedKlnToHK)}">${speedKlnToHK}mph</span>
                    </div>
                    <div class="speed-item">
                        <span class="speed-dir">‚¨ÖÔ∏è HK‚ÜíK</span>
                        <span class="speed-val ${getSpeedClass(speedHkToKln)}">${speedHkToKln}mph</span>
                    </div>
                </div>
            `;
        }
        flowContainer.innerHTML = html;
    } catch (e) {
        // Ê®°Êì¨Êï∏Êìö
        const mockSpeeds = [24,28,32,30,36,38];
        let html = '';
        const tunnels = ['CHT','WHC','EHC'];
        tunnels.forEach((tunnel, i) => {
            const getSpeedClass = (mph) => mph >= 31 ? 'speed-good' : mph >= 19 ? 'speed-slow' : 'speed-congested';
            html += `
                <div class="speed-group">
                    <div class="speed-name">${tunnel}</div>
                    <div class="speed-item">
                        <span class="speed-dir">‚û°Ô∏è K‚ÜíHK</span>
                        <span class="speed-val ${getSpeedClass(mockSpeeds[i*2])}">${mockSpeeds[i*2]}mph</span>
                    </div>
                    <div class="speed-item">
                        <span class="speed-dir">‚¨ÖÔ∏è HK‚ÜíK</span>
                        <span class="speed-val ${getSpeedClass(mockSpeeds[i*2+1])}">${mockSpeeds[i*2+1]}mph</span>
                    </div>
                </div>
            `;
        });
        flowContainer.innerHTML = html;
    }
}

// 3Ô∏è‚É£ ‰∫§ÈÄöÊ∂àÊÅØÁõ¥Âºè
async function updateTrafficNews() {
    const trafficContainer = document.getElementById('trafficNews');
    const RSS_PROXIES = ['https://api.allorigins.win/raw?url='];
    const TRAFFIC_RSS = 'https://resource.data.one.gov.hk/td/en/specialtrafficnews.xml';
    
    for(let proxy of RSS_PROXIES){
        try{
            const proxyUrl = proxy + encodeURIComponent(TRAFFIC_RSS);
            const resp = await fetch(proxyUrl, {mode:'cors', cache:'no-cache'});
            const text = await resp.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text,"text/xml");
            if(xmlDoc.querySelector('parsererror')) throw new Error('XML parse error');
            
            const items = xmlDoc.querySelectorAll('item');
            let html = '';
            Array.from(items).slice(0,6).forEach(item=>{
                let title = item.querySelector('title')?.textContent.trim() || '';
                if(title && /[A-Za-z]/.test(title)){
                    const pubDate = item.querySelector('pubDate') ? new Date(item.querySelector('pubDate').textContent) : new Date();
                    let icon = 'üö®';
                    if(title.toLowerCase().includes('tunnel')) icon='üöá';
                    else if(title.toLowerCase().includes('road')) icon='üõ£Ô∏è';
                    
                    html += `
                        <div class="traffic-item">
                            <span class="traffic-icon">${icon}</span>
                            <div class="traffic-text">
                                <div class="traffic-title">${title}</div>
                                <div class="traffic-time">${pubDate.toLocaleTimeString('en-GB',{hour12:false})}</div>
                            </div>
                        </div>
                    `;
                }
            });
            if(html){
                trafficContainer.innerHTML = html;
                return;
            }
        }catch(e){
            console.error('Traffic error:', e);
        }
    }
    trafficContainer.innerHTML = '<div class="no-data">No traffic alerts</div>';
}

// Â§©Ê∞£„ÄÅÊñ∞ËÅûÔºà‰∏çËÆäÔºâ
async function updateWeather() {
    try {
        const resp = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=22.3964&lon=114.1095&appid=${OW_API_KEY}&units=metric&lang=en`);
        const data = await resp.json();
        if(data.cod === 200){
            const temp = Math.round(data.main.temp);
            const feelsLike = Math.round(data.main.feels_like);
            const humidity = data.main.humidity;
            const windSpeed = Math.round(data.wind.speed * 2.23694);
            const desc = data.weather[0].description.charAt(0).toUpperCase() + data.weather[0].description.slice(1);
            const iconCode = data.weather[0].icon;
            const iconMap = {'01d':'‚òÄÔ∏è','01n':'üåô','02d':'‚õÖ','02n':'‚õÖ','03d':'‚òÅÔ∏è','03n':'‚òÅÔ∏è','04d':'‚òÅÔ∏è','04n':'‚òÅÔ∏è','09d':'üå¶Ô∏è','09n':'üå¶Ô∏è','10d':'üåßÔ∏è','10n':'üåßÔ∏è','11d':'‚õàÔ∏è','11n':'‚õàÔ∏è','13d':'‚ùÑÔ∏è','13n':'‚ùÑÔ∏è','50d':'üå´Ô∏è','50n':'üå´Ô∏è'};
            document.getElementById('weatherIcon').textContent = iconMap[iconCode]||'üå§Ô∏è';
            document.getElementById('weatherTemp').textContent = `${temp}¬∞C`;
            document.getElementById('weatherDesc').textContent = `${desc} ‚Ä¢ ${humidity}%`;
            document.getElementById('weatherDetails').textContent = `Feels ${feelsLike}¬∞C ‚Ä¢ Wind ${windSpeed}mph`;
            let warning = '';
            if(temp>33) warning='Very Hot ‚òÄÔ∏è'; else if(temp<12) warning='Very Cold ‚ùÑÔ∏è'; else if(humidity>90) warning='Very Humid üíß'; else if(data.weather[0].main==='Rain') warning='Rainy üåßÔ∏è';
            document.getElementById('weatherWarning').innerHTML = warning ? `<div class="weather-warning">${warning}</div>` : '';
        }
    } catch(e){console.error(e);}
}

async function updateNews() {
    const newsContainer = document.getElementById('heroNews');
    const newsCountEl = document.getElementById('newsCount');
    newsContainer.innerHTML = '<div class="loading">Loading latest news...</div>';
    try {
        const resp = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent('https://www.scmp.com/rss/91/feed'));
        const text = await resp.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(text, "text/xml");
        const items = xmlDoc.querySelectorAll('item');
        newsData = [];
        let html = '';
        Array.from(items).slice(0, 12).forEach((item,i)=>{
            const title = item.querySelector('title')?.textContent.trim() || '';
            const pubDate = item.querySelector('pubDate') ? new Date(item.querySelector('pubDate').textContent) : new Date();
            newsData.push({title, pubDate, index: i});
            const titleShort = title.length > 80 ? title.substring(0, 80) + '...' : title;
            html += `<div class="news-item" onclick="openNewsModal(${i})">
                <div class="news-content">
                  <div class="news-title">${titleShort}</div>
                  <div class="news-source">SCMP</div>
                  <div class="news-time">${pubDate.toLocaleDateString('en-GB')}</div>
                </div>
                <span class="news-badge">NEW</span>
            </div>`;
        });
        newsContainer.innerHTML = html;
        newsCountEl.textContent = `(${newsData.length})`;
    } catch(e){
        newsContainer.innerHTML = '<div class="error">News loading failed.</div>';
        console.error('News error:', e);
    }
}

function openNewsModal(idx){
    if(newsData[idx]){
        const news = newsData[idx];
        document.getElementById('modalTitle').textContent = news.title;
        document.getElementById('modalSource').textContent = 'SCMP';
        document.getElementById('modalTime').textContent = news.pubDate ? news.pubDate.toLocaleString('en-GB') : '';
        document.getElementById('modalDescription').textContent = 'Full article available on SCMP website.';
        document.getElementById('newsModal').style.display = 'block';
    }
}

document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('modalClose').onclick=()=>{document.getElementById('newsModal').style.display='none';};
});

window.onclick = (event) => {
    const modal = document.getElementById('newsModal');
    if(event.target === modal) modal.style.display = 'none';
};

// ÂÖ®liveÂïüÂãï
updateWeather();
updateNews();
updateTunnelTolls();
updateTunnelFlow();
updateTrafficNews();

setInterval(updateWeather, 300000);
setInterval(updateNews, 300000);
setInterval(updateTunnelTolls, 60000);
setInterval(updateTunnelFlow, 30000);
setInterval(updateTrafficNews, 120000);
</script>
</body>
</html>
