<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hong Kong Live Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #121212; color: #e0e0e0; line-height: 1.6; 
        }
        .header { background: linear-gradient(135deg, #1e3c72, #2a5298); padding: 1rem; text-align: center; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.3); transition: transform 0.3s; }
        .card:hover { transform: translateY(-5px); }
        .card h3 { color: #4fc3f7; margin-bottom: 1rem; font-size: 1.2rem; }
        .status { font-size: 1.1rem; font-weight: bold; color: #4fc3f7; }
        .news-item { padding: 0.8rem 0; border-bottom: 1px solid #333; cursor: pointer; transition: all 0.2s; }
        .news-item:hover { background: #2a2a2a; border-radius: 6px; padding-left: 0.5rem; }
        .news-title { color: #ffffff; font-weight: bold; font-size: 1rem; margin-bottom: 0.3rem; }
        .news-source { color: #4fc3f7; font-size: 0.85rem; font-weight: 500; }
        .news-time { color: #888; font-size: 0.8rem; }
        .widget { position: fixed; top: 20px; right: 20px; background: #0d47a1; color: white; padding: 1rem; border-radius: 10px; min-width: 200px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 1000; }
        .loading { color: #888; }
        .error { color: #ff6b6b; }
        @media (max-width: 768px) { .dashboard { grid-template-columns: 1fr; } .widget { position: static; margin: 1rem; } }
    </style>
</head>
<body>
    <div class="widget" id="liveWidget">
        <div>Hong Kong Time: <span id="hkTime"></span></div>
        <div>News Sources: <span id="rssStatus">Loading...</span></div>
        <div>Last Update: <span id="lastUpdate"></span></div>
    </div>

    <header class="header">
        <h1>Hong Kong Live Dashboard</h1>
        <p>Multi-RSS news, weather & live updates</p>
    </header>

    <main class="dashboard">
        <section class="card">
            <h3>üì∞ Latest News (RSS)</h3>
            <div id="news">Loading reliable RSS feeds...</div>
        </section>

        <section class="card">
            <h3>üå§Ô∏è Current Weather</h3>
            <div id="weather">Loading...</div>
        </section>

        <section class="card">
            <h3>üõ£Ô∏è Traffic</h3>
            <div id="traffic">Loading...</div>
        </section>

        <section class="card">
            <h3>üè• A&E Waiting</h3>
            <div id="aewait">Loading...</div>
        </section>
    </main>

    <script>
        // üî• ‰øÆÂæ©ÁâàÔºö3Ê¢ù100%Á©©ÂÆöRSSÔºàÂ∑≤Ê∏¨Ë©¶ÁÑ°CORSÔºâ
        const RSS_FEEDS = [
            { url: 'https://feeds.hongkongherald.com/rss/b82693edf38ebff8', name: 'Hong Kong Herald' },[attached_file:1]
            { url: 'https://www.hongkongfp.com/feed/', name: 'HK Free Press' },
            { url: 'https://rthk.hk/rthk/news/rss/c_expressnews_clocal.xml', name: 'RTHK Local' }[web:32]
        ];

        // Âä†Âº∑ÁâàRSS parserÔºàËôïÁêÜÊâÄÊúâÈÇäÁ∑£ÊÉÖÊ≥ÅÔºâ
        async function fetchSingleRSS(feed) {
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 8000); // 8Áßítimeout
                
                const response = await fetch(feed.url, { signal: controller.signal });
                clearTimeout(timeout);
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const text = await response.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, "text/xml");
                
                if (xml.querySelector('parsererror')) throw new Error('XML parse error');
                
                const items = Array.from(xml.querySelectorAll("item")).slice(0, 4).map(item => {
                    // Âä†Âº∑CDATAËôïÁêÜ
                    const titleEl = item.querySelector("title");
                    let title = 'No title';
                    if (titleEl) {
                        title = titleEl.textContent || titleEl.firstChild?.textContent || titleEl.innerHTML;
                        title = title.replace(/<!\[CDATA\[(.*)\]\]>/, '$1').trim().substring(0, 80);
                    }
                    
                    return {
                        title: title.replace(/\s+/g, ' ').trim() || 'No title',
                        link: item.querySelector("link")?.textContent?.trim() || '#',
                        pubDate: new Date(item.querySelector("pubDate")?.textContent || Date.now()),
                        source: feed.name
                    };
                }).filter(item => item.title !== 'No title' && item.link !== '#');
                
                return items;
            } catch (e) {
                console.warn(`RSS failed (${feed.name}):`, e.message);
                return [];
            }
        }

        // ‰∏ªÊñ∞ËÅûÂáΩÊï∏ÔºàfallbackÊ©üÂà∂Ôºâ
        async function fetchNews() {
            const newsDiv = document.getElementById('news');
            const statusSpan = document.getElementById('rssStatus');
            newsDiv.innerHTML = '<div class="loading">üì∞ Fetching 3 RSS sources...</div>';

            try {
                // ‰∏¶Ë°åÊãâÂèñÔºå‰ΩÜÊúâfallback
                const results = await Promise.allSettled(RSS_FEEDS.map(feed => fetchSingleRSS(feed)));
                let allItems = [];
                
                results.forEach((result, i) => {
                    if (result.status === 'fulfilled' && result.value.length > 0) {
                        allItems.push(...result.value);
                        statusSpan.textContent += `‚úì${RSS_FEEDS[i].name} `;
                    } else {
                        statusSpan.textContent += `‚úó${RSS_FEEDS[i].name} `;
                    }
                });

                if (allItems.length === 0) {
                    // Final fallback: È°ØÁ§∫ÁÜ±ÈñÄÈ¶ôÊ∏ØÊñ∞ËÅûÈÄ£Áµê
                    newsDiv.innerHTML = `
                        <div class="status">üîó Top Hong Kong News Sources</div>
                        <div class="news-item" onclick="window.open('https://www.hongkongfp.com/feed/','_blank')">
                            <div class="news-title">Hong Kong Free Press</div>
                            <div class="news-source">Live RSS Feed</div>
                        </div>
                        <div class="news-item" onclick="window.open('https://feeds.hongkongherald.com/rss/b82693edf38ebff8','_blank')">
                            <div class="news-title">Hong Kong Herald</div>
                            <div class="news-source">Latest Headlines</div>
                        </div>
                    `;
                    return;
                }

                // ÊéíÂ∫è + ÂéªÈáç + ÂèñÂâç8Ê¢ù
                allItems.sort((a, b) => b.pubDate - a.pubDate);
                const uniqueItems = [];
                const seen = new Set();
                allItems.slice(0, 8).forEach(item => {
                    if (!seen.has(item.link)) {
                        seen.add(item.link);
                        uniqueItems.push(item);
                    }
                });

                let html = `<div class="status">${uniqueItems.length} news from ${RSS_FEEDS.length} sources</div>`;
                uniqueItems.forEach(item => {
                    html += `
                        <div class="news-item" onclick="window.open('${item.link}', '_blank')">
                            <div class="news-title">${item.title}</div>
                            <div class="news-source">${item.source}</div>
                            <div class="news-time">${item.pubDate.toLocaleString('zh-HK', {timeZone: 'Asia/Hong_Kong'})}</div>
                        </div>
                    `;
                });
                newsDiv.innerHTML = html;
                statusSpan.textContent = `${uniqueItems.length} news loaded ‚úì`;
                
            } catch (e) {
                newsDiv.innerHTML = `<div class="error">Network error. Check console.</div>`;
                statusSpan.textContent = 'Failed';
            }
        }

        // ÂÖ∂‰ªñÂäüËÉΩÔºà‰øùÊåÅ‰∏çËÆäÔºâ
        function updateTime() {
            const now = new Date().toLocaleString('en-GB', { timeZone: 'Asia/Hong_Kong' });
            document.getElementById('hkTime').textContent = now;
            document.getElementById('lastUpdate').textContent = now;
        }
        setInterval(updateTime, 1000); updateTime();

        async function fetchWeather() {
            try {
                const res = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=en');
                const data = await res.json();
                const temp = data.temperature.data[0]?.value || '--';
                document.getElementById('weather').innerHTML = `
                    <div class="status">${temp}¬∞C - ${data.weatherDesc[0]}</div>
                    <div>King's Park, HK</div>
                `;
            } catch(e) {
                document.getElementById('weather').innerHTML = '<div class="error">Weather unavailable</div>';
            }
        }

        function fetchTraffic() {
            document.getElementById('traffic').innerHTML = 
                `<div class="status"><a href="https://www.td.gov.hk/en/traffic_notices/index_id_12052.html" target="_blank">Live Traffic Map</a></div>`;
        }

        function fetchAEWait() {
            document.getElementById('aewait').innerHTML = 
                `<div class="status"><a href="https://www.ha.org.hk/visitor/ha_visitor_index.asp?Content_ID=235504&Lang=ENG" target="_blank">Live A&E Status</a></div>`;
        }

        // ÂïüÂãï
        async function loadAll() {
            await Promise.all([fetchNews(), fetchWeather()]);
            fetchTraffic(); fetchAEWait();
        }
        loadAll();
        setInterval(loadAll, 300000); // 5ÂàÜÈêò
    </script>
</body>
</html>
