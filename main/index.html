<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Hong Kong Live Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  background:#050510;color:#e0e0e0;min-height:100vh;padding:2rem 0;
}
.row1{
  display:grid;grid-template-columns:22% 26% 26% 26%;
  gap:1.1rem;max-width:1400px;margin:0 auto 1.6rem auto;
  padding:0 2rem;height:310px;
}
.row2{
  display:flex;justify-content:center;gap:3rem;
  max-width:1400px;margin:0 auto 1.6rem auto;padding:0 2rem;
}
.row3{
  max-width:1400px;margin:0 auto 1.6rem auto;
  padding:0 2rem;min-height:40px;
}

/* Weather */
.weather-hero{
  background:radial-gradient(circle at top left,#284073,#151528);
  border-radius:24px;padding:1.2rem 1.4rem;
  box-shadow:0 12px 40px rgba(0,0,0,0.55);
  display:flex;flex-direction:column;justify-content:center;
  text-align:center;position:relative;overflow:hidden;height:100%;
}
.weather-hero::before{
  content:'üå§Ô∏è';font-size:3.2rem;position:absolute;
  top:12px;right:12px;opacity:.13;
}
.weather-icon{font-size:2.2rem;margin-bottom:.25rem;}
.weather-temp{font-size:3rem;font-weight:300;color:#fff;margin-bottom:.2rem;}
.weather-desc{font-size:1.1rem;color:#d0e4ff;margin-bottom:.3rem;font-weight:500;}
.weather-details{font-size:.95rem;color:#b3d9ff;}
.weather-warning{
  background:linear-gradient(45deg,#ff6b6b,#ffb36b);
  color:#fff;padding:.45rem 1.1rem;border-radius:20px;
  font-weight:600;margin-top:.8rem;font-size:.8rem;
}

/* News */
.news-hero{
  background:#161623;border-radius:24px;padding:1.2rem 1.15rem;
  box-shadow:0 12px 40px rgba(0,0,0,0.6);
  overflow-y:auto;backdrop-filter:blur(10px);
  display:flex;flex-direction:column;font-size:.82rem;
  line-height:1.25;border:1px solid #26263a;height:100%;
}
.hero-title{color:#fff;font-size:1.06rem;font-weight:700;margin-bottom:.32rem;}
.news-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.3rem;}
.news-count{font-size:.78rem;color:#aaa;}
.news-item{
  padding:.5rem 0;border-bottom:1px solid #303046;
  cursor:pointer;transition:all .15s ease;
  display:flex;align-items:flex-start;gap:.5rem;
}
.news-item:last-child{border-bottom:none;}
.news-item:hover{background:rgba(76,175,80,0.11);border-radius:10px;}
.news-content{flex:1;}
.news-title{
  color:#fff;font-weight:600;font-size:.87rem;
  line-height:1.18;margin-bottom:.1rem;
}
.news-source{color:#ff8a80;font-size:.7rem;font-weight:600;}
.news-time{color:#888;font-size:.68rem;margin-top:.09rem;}

/* Icon buttons */
.icon-btn{
  position:relative;cursor:pointer;background:#1a1f3a;
  border-radius:50%;width:85px;height:85px;
  box-shadow:0 12px 28px rgba(0,0,0,0.6);
  display:flex;flex-direction:column;justify-content:center;
  align-items:center;transition:all .25s ease;
  font-size:36px;margin:0 auto;user-select:none;
}
.icon-btn:hover{
  transform:translateY(-10px) scale(1.06);
  box-shadow:0 24px 50px rgba(0,0,0,0.85);
}
.icon-btn.tunnel{background:linear-gradient(135deg,#2d4373,#1a1f3d);}
.icon-btn.road{background:linear-gradient(135deg,#2d5a4a,#1a332e);}
.icon-btn.traffic{background:linear-gradient(135deg,#4a1f1f,#2a1717);}
.icon-btn.immigration{background:linear-gradient(135deg,#4a2a5a,#2a1f3d);}
.icon-label{
  font-size:11px;color:#a0b1f9;text-align:center;
  font-weight:500;margin-top:4px;line-height:1.1;
}

/* Modal */
.modal-overlay{
  display:none;position:fixed;z-index:3000;left:0;top:0;
  width:100vw;height:100vh;background:rgba(0,15,44,0.95);
  backdrop-filter:blur(15px);
}
.modal-content{
  background:#273347;margin:4vh auto;padding:2.4rem 2.2rem;
  border-radius:28px;width:92vw;max-width:700px;
  max-height:85vh;color:#ececec;overflow-y:auto;
  box-shadow:0 25px 80px rgba(0,0,0,0.9);
}
.modal-header{
  display:flex;justify-content:space-between;
  align-items:center;margin-bottom:1.8rem;
}
.modal-title{font-size:1.3rem;font-weight:700;}
.modal-time{font-size:.85rem;color:#9ab3ff;margin-top:.3rem;}
.modal-close{
  font-size:2.4rem;font-weight:bold;color:#bbb;
  cursor:pointer;padding:.3rem;transition:color .2s;
}
.modal-close:hover{color:#fff;}
.modal-body{font-size:.92rem;line-height:1.5;}
.data-table{
  width:100%;border-collapse:collapse;
  margin-top:1.2rem;font-size:.88rem;
}
.data-table th,.data-table td{
  padding:.7rem .9rem;text-align:left;
  border-bottom:1px solid #3a4250;
}
.data-table th{
  font-weight:600;color:#fff;
  background:rgba(255,255,255,0.06);
}
.speed-good{color:#4ad16a;}
.speed-slow{color:#ffb347;}
.speed-congested{color:#ff6b6b;}
.loading,.no-data{
  color:#888;text-align:center;padding:2.5rem;font-style:italic;
}
.error{color:#ff6b6b;text-align:center;padding:2.5rem;font-weight:500;}
.update-time{color:#7facff;font-size:.82rem;text-align:right;margin-top:1rem;}

@media(max-width:1200px){
  .row1{grid-template-columns:1fr 1fr;height:auto;}
  .row2,.row3{flex-wrap:wrap;gap:2rem;}
  .icon-btn{width:70px;height:70px;font-size:28px;}
}
</style>
</head>
<body>

<!-- Row1: Weather + 3 News -->
<section class="row1">
  <div class="weather-hero">
    <div class="weather-icon" id="weatherIcon">üå§Ô∏è</div>
    <div class="weather-temp" id="weatherTemp">--¬∞C</div>
    <div class="weather-desc" id="weatherDesc">--</div>
    <div class="weather-details" id="weatherDetails">Hong Kong</div>
    <div id="weatherWarning"></div>
  </div>
  <div class="news-hero">
    <div class="news-header">
      <div class="hero-title">Hong Kong News</div>
      <span class="news-count" id="hkNewsCount">(0)</span>
    </div>
    <div id="hkNews"><div class="loading">Loading...</div></div>
  </div>
  <div class="news-hero">
    <div class="news-header">
      <div class="hero-title">International</div>
      <span class="news-count" id="intNewsCount">(0)</span>
    </div>
    <div id="intNews"><div class="loading">Loading...</div></div>
  </div>
  <div class="news-hero">
    <div class="news-header">
      <div class="hero-title">UK News</div>
      <span class="news-count" id="ukNewsCount">(0)</span>
    </div>
    <div id="ukNews"><div class="loading">Loading...</div></div>
  </div>
</section>

<!-- Row2: 4 icons: Tunnels / Roads / Traffic / Immigration -->
<section class="row2">
  <div class="icon-btn tunnel" onclick="showPanel('tunnels')">
    üöá<div class="icon-label">Tunnels</div>
  </div>
  <div class="icon-btn road" onclick="showPanel('roads')">
    üõ£Ô∏è<div class="icon-label">Roads</div>
  </div>
  <div class="icon-btn traffic" onclick="showPanel('traffic')">
    üö®<div class="icon-label">Traffic</div>
  </div>
  <div class="icon-btn immigration" onclick="showPanel('immigration')">
    üõÇ<div class="icon-label">Immigration</div>
  </div>
</section>

<!-- Row3: Êö´Á©∫‰ΩçÔºà‰πãÂæåÂèØÂä†ÂÖ∂‰ªñÂÖßÂÆπÔºâ -->
<section class="row3">
</section>

<!-- Shared modal -->
<div id="dataModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div>
        <div id="modalTitle" class="modal-title">Loading...</div>
        <div id="modalTime" class="modal-time"></div>
      </div>
      <span class="modal-close" onclick="closeModal()">&times;</span>
    </div>
    <div id="modalBody" class="modal-body">
      <div class="loading">Loading...</div>
    </div>
  </div>
</div>

<script>
const OW_API_KEY = 'f19c9c1cfbb572c048a0a99c38f012d2';
const cache = new Map();

// ÈÄöÁî® proxy fetch
async function fetchViaProxy(url, key, isText=false, ttl=300000){
  const cached = cache.get(key);
  if(cached && Date.now()-cached.time < ttl) return cached.data;
  try{
    const res = await fetch('https://api.allorigins.win/raw?url='+encodeURIComponent(url), {cache:'no-cache'});
    const data = isText ? await res.text() : await res.json();
    cache.set(key,{data,time:Date.now()});
    return data;
  }catch(e){
    console.error('Fetch error', key, e);
    return null;
  }
}

// Weather
async function loadWeather(){
  const url = `https://api.openweathermap.org/data/2.5/weather?lat=22.3964&lon=114.1095&appid=${OW_API_KEY}&units=metric&lang=en`;
  const data = await fetchViaProxy(url,'weather',false,300000);
  if(!data || data.cod!==200) return;
  const t = Math.round(data.main.temp);
  const feels = Math.round(data.main.feels_like);
  const hum = data.main.humidity;
  const wind = Math.round(data.wind.speed*3.6);
  const desc = data.weather[0].description.replace(/\b\w/g,c=>c.toUpperCase());
  const iconMap={'01d':'‚òÄÔ∏è','01n':'üåô','02d':'‚õÖ','03d':'‚òÅÔ∏è','04d':'‚òÅÔ∏è','09d':'üå¶Ô∏è','10d':'üåßÔ∏è','11d':'‚õàÔ∏è','13d':'‚ùÑÔ∏è','50d':'üå´Ô∏è'};
  const icon = iconMap[data.weather[0].icon]||'üå§Ô∏è';

  document.getElementById('weatherIcon').textContent = icon;
  document.getElementById('weatherTemp').textContent = `${t}¬∞C`;
  document.getElementById('weatherDesc').textContent = `${desc} ‚Ä¢ ${hum}%`;
  document.getElementById('weatherDetails').textContent = `Feels ${feels}¬∞C ‚Ä¢ ${wind} km/h`;
}

// RSS
async function loadRSS(url, key, containerId, countId, sourceLabel){
  const text = await fetchViaProxy(url,key,true,300000);
  const container = document.getElementById(containerId);
  const countEl = document.getElementById(countId);
  if(!text){
    container.innerHTML='<div class="error">Unable to load news</div>';
    countEl.textContent='(0)';
    return;
  }
  const parser = new DOMParser();
  const xml = parser.parseFromString(text,'application/xml');
  const items = Array.from(xml.getElementsByTagName('item')).slice(0,10);
  let html=''; let count=0;
  items.forEach(item=>{
    const title = item.getElementsByTagName('title')[0]?.textContent?.trim()||'';
    const pub = item.getElementsByTagName('pubDate')[0]?.textContent||'';
    if(!title) return;
    count++;
    const short = title.length>80?title.slice(0,80)+'...':title;
    const d = pub?new Date(pub):null;
    html += `<div class="news-item">
      <div class="news-content">
        <div class="news-title">${short}</div>
        <div class="news-source">${sourceLabel}</div>
        <div class="news-time">${d?d.toLocaleString('en-GB'):''}</div>
      </div>
    </div>`;
  });
  container.innerHTML = html || '<div class="no-data">No news</div>';
  countEl.textContent = `(${count})`;
}

// Modal ÊéßÂà∂
function closeModal(){document.getElementById('dataModal').style.display='none';}
window.addEventListener('click',e=>{if(e.target.id==='dataModal')closeModal();});

async function showPanel(type){
  const modal = document.getElementById('dataModal');
  const titleEl = document.getElementById('modalTitle');
  const timeEl = document.getElementById('modalTime');
  const bodyEl = document.getElementById('modalBody');
  modal.style.display='block';
  bodyEl.innerHTML='<div class="loading">Loading...</div>';
  timeEl.textContent='';

  const nowStr = new Date().toLocaleString('en-GB');

  if(type==='tunnels'){
    titleEl.textContent='üöá Tunnels ‚Äì Tolls & Live Speeds';
    const data = await fetchViaProxy('https://resource.data.one.gov.hk/td/traffic-speed-map/en/tunnels.json','tunnels',false,60000);
    renderTunnels(data,bodyEl);
  }else if(type==='roads'){
    titleEl.textContent='üõ£Ô∏è Major Roads ‚Äì Live Speeds';
    const data = await fetchViaProxy('https://resource.data.one.gov.hk/td/traffic-speed-map/en/roads.json','roads',false,60000);
    renderRoads(data,bodyEl);
  }else if(type==='traffic'){
    titleEl.textContent='üö® Traffic News & Alerts';
    const text = await fetchViaProxy('https://resource.data.one.gov.hk/td/en/specialtrafficnews.xml','traffic',true,60000);
    renderTraffic(text,bodyEl);
  }else if(type==='immigration'){
    titleEl.textContent='üõÇ Immigration Waiting Times';
    const data = await fetchViaProxy('https://secure1.info.gov.hk/immd/mobileapps/2bb9ae17/data/CPQueueTimeR.json','immigration',false,60000);
    renderImmigration(data,bodyEl);
  }
  timeEl.textContent = `Updated: ${nowStr}`;
}

// Render Tunnels
function renderTunnels(data,container){
  if(!data || Object.keys(data).length===0){
    container.innerHTML='<div class="error">No tunnel data available</div>';return;
  }
  const map={cht:'Cross-Harbour Tunnel',ehc:'Eastern Harbour Crossing',whc:'Western Harbour Crossing'};
  let html='<table class="data-table"><thead><tr><th>Tunnel</th><th>Kln ‚Üí HK</th><th>HK ‚Üí Kln</th><th>Average</th></tr></thead><tbody>';
  Object.entries(map).forEach(([key,name])=>{
    const obj=data[key];
    if(!obj){return;}
    const s1 = typeof obj.klnToHk?.speed==='number'?obj.klnToHk.speed:null;
    const s2 = typeof obj.hkToKln?.speed==='number'?obj.hkToKln.speed:null;
    if(s1===null && s2===null) return;
    const sum = (s1||0)+(s2||0);
    const cnt = (s1!==null?1:0)+(s2!==null?1:0) || 1;
    const avg = Math.round(sum/cnt);
    const cls = avg>=50?'speed-good':avg>=30?'speed-slow':'speed-congested';
    html+=`<tr>
      <td>${name}</td>
      <td class="${cls}">${s1!==null?s1+' km/h':'N/A'}</td>
      <td class="${cls}">${s2!==null?s2+' km/h':'N/A'}</td>
      <td class="${cls}">${avg} km/h</td>
    </tr>`;
  });
  html+='</tbody></table>';
  container.innerHTML=html;
}

// Render Roads
function renderRoads(data,container){
  if(!data || Object.keys(data).length===0){
    container.innerHTML='<div class="error">No road data available</div>';return;
  }
  const map={
    tsingshahwy:'Tsing Sha Highway',
    westkowlooncor:'West Kowloon Corridor',
    islandeasterncor:'Island Eastern Corridor',
    tsingkwaihwy:'Tsing Kwai Highway',
    northlantauhwy:'North Lantau Highway',
    tsuenmunrd:'Tsuen Mun Road',
    kwuntongrd:'Kwun Tong Road'
  };
  let html='<div style="max-height:420px;overflow:auto;">';
  html+='<table class="data-table"><thead><tr><th>Road</th><th>Current Speed</th></tr></thead><tbody>';
  Object.entries(map).forEach(([key,name])=>{
    const arr = data[key] || data[key.toUpperCase()] || [];
    const speed = typeof arr[0]?.speed==='number'?arr[0].speed:null;
    if(speed===null) return;
    const cls = speed>=50?'speed-good':speed>=30?'speed-slow':'speed-congested';
    html+=`<tr><td>${name}</td><td class="${cls}">${speed} km/h</td></tr>`;
  });
  html+='</tbody></table></div>';
  container.innerHTML=html;
}

// Render Traffic
function renderTraffic(xmlText,container){
  if(!xmlText){
    container.innerHTML='<div class="error">No traffic news available</div>';return;
  }
  const parser=new DOMParser();
  const xml=parser.parseFromString(xmlText,'application/xml');
  const messages=Array.from(xml.getElementsByTagName('message')).slice(0,15);
  if(!messages.length){
    container.innerHTML='<div class="no-data">No active traffic alerts</div>';return;
  }
  let html='<div style="max-height:420px;overflow:auto;">';
  messages.forEach(m=>{
    const title=m.getElementsByTagName('EngShort')[0]?.textContent?.trim()||'';
    const date=m.getElementsByTagName('ReferenceDate')[0]?.textContent?.trim()||'';
    if(!title) return;
    html+=`<div style="padding:.9rem 0;border-bottom:1px solid #3a4250;">
      <div style="font-weight:600;margin-bottom:.25rem;">${title}</div>
      <div style="color:#9ab3ff;font-size:.85rem;">${date}</div>
    </div>`;
  });
  html+='</div>';
  container.innerHTML=html;
}

// Render Immigration
function renderImmigration(data,container){
  if(!data || Object.keys(data).length===0){
    container.innerHTML='<div class="error">No immigration data available</div>';return;
  }
  const map={
    HYW:'Heung Yuen Wai',
    HZM:'HZMB',
    LMC:'Lok Ma Chau Spur Line',
    LSC:'Lok Ma Chau',
    LWS:'Lo Wu',
    MKT:'Man Kam To',
    SBC:'Sha Tau Kok',
    STK:'Shatoujiao'
  };
  let html='<table class="data-table"><thead><tr><th>Checkpoint</th><th>Arrival</th><th>Departure</th></tr></thead><tbody>';
  Object.entries(map).forEach(([code,name])=>{
    const obj=data[code];
    if(!obj) return;
    const arr=obj.arrQueue===99?'N/A':obj.arrQueue+' min';
    const dep=obj.depQueue===99?'N/A':obj.depQueue+' min';
    html+=`<tr><td style="font-weight:500;">${name}</td><td>${arr}</td><td>${dep}</td></tr>`;
  });
  html+='</tbody></table>';
  container.innerHTML=html;
}

// ÂàùÂßãÂåñÔºöÁ¨¨‰∏ÄË°å + ÊØè5ÂàÜÈêòÊõ¥Êñ∞
async function initFirstRow(){
  await loadWeather();
  await loadRSS('https://rthk9.rthk.hk/rthk/news/rss/e_expressnews_elocal.xml',
                'rss_hk','hkNews','hkNewsCount','RTHK Local');
  await loadRSS('https://rthk9.rthk.hk/rthk/news/rss/e_expressnews_einternational.xml',
                'rss_int','intNews','intNewsCount','RTHK World');
  await loadRSS('https://feeds.skynews.com/feeds/rss/uk.xml',
                'rss_uk','ukNews','ukNewsCount','Sky News UK');
}

initFirstRow();
setInterval(initFirstRow,5*60*1000); // ÊØè5ÂàÜÈêòËá™ÂãïÊõ¥Êñ∞Á¨¨1Ë°å + Êñ∞ËÅû
</script>
</body>
</html>
