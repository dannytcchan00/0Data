<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hong Kong Live Dashboard</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #050510; color: #e0e0e0; min-height: 100vh; padding: 2rem 0;}
    
    .row1 { display: grid; grid-template-columns: 20% 80%; gap: 1.5rem; max-width: 1400px; margin: 0 auto 1.5rem auto; padding: 0 2rem; height: 420px;}
    /* üî• ‰∏âÊ¨ÑÁ≠âÂØ¨ÔºöÈößÈÅì | ‰∏ªË¶ÅÈÅìË∑Ø | ‰∫§ÈÄö */
    .row2 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; max-width: 1400px; margin: 0 auto; padding: 0 2rem; height: 380px;}
    
    /* Â§©Ê∞£ */
    .weather-hero {
        background: radial-gradient(circle at top left, #2d4373, #151528);
        border-radius: 24px; padding: 1.8rem 1.5rem; box-shadow: 0 12px 40px rgba(0,0,0,0.55);
        display: flex; flex-direction: column; justify-content: center; text-align: center;
        position: relative; overflow: hidden; width: 100%; min-height: 0;
    }
    .weather-hero::before {content: 'üå§Ô∏è'; font-size: 3.5rem; position: absolute; top: 10px; right: 10px; opacity: 0.18;}
    
    /* Êñ∞ËÅû */
    .news-hero {
        background: #161623; border-radius: 24px; padding: 1.8rem 2rem; box-shadow: 0 12px 40px rgba(0,0,0,0.6);
        overflow-y: auto; backdrop-filter: blur(10px); min-height: 0; display: flex; flex-direction: column;
        font-size: 0.85rem; line-height: 1.3; border: 1px solid #26263a;
    }

    .hero-title {color: #ffffff; font-size: 1.2rem; font-weight: 700; margin-bottom: 0.8rem;}
    .weather-temp {font-size: 3.8rem; font-weight: 300; color: #ffffff; margin-bottom: 0.5rem; letter-spacing: -2px;}
    .weather-desc {font-size: 1.3rem; color: #d0e4ff; margin-bottom: 0.8rem; font-weight: 500;}
    .weather-details {font-size: 1rem; color: #b3d9ff;}
    .weather-warning {background: linear-gradient(45deg, #ff6b6b, #ffb36b); color: white; padding: 0.6rem 1.2rem; border-radius: 20px; font-weight: 600; margin-top: 0.8rem; font-size: 0.85rem;}
    .weather-icon {font-size: 2.5rem; margin-bottom: 0.3rem;}

    .news-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.3rem;}
    .news-item {padding: 1rem 0; border-bottom: 1px solid #303046; cursor: pointer; transition: all 0.25s ease; display: flex; align-items: flex-start; gap: 0.9rem; position: relative;}
    .news-item:hover {background: rgba(76,175,80,0.12); border-radius: 14px; padding: 1rem 1.4rem 1rem 1.7rem; transform: translateX(4px); border-left: 3px solid #4caf50; box-shadow: 0 4px 15px rgba(0,0,0,0.5);}
    .news-content {flex: 1;}
    .news-title {color: #ffffff; font-weight: 600; font-size: 0.95rem; line-height: 1.3; margin-bottom: 0.2rem;}
    .news-source {color: #ff8a80; font-size: 0.8rem; font-weight: 700;}
    .news-time {color: #888; font-size: 0.7rem; margin-top: 0.15rem;}
    .news-badge {background: #4caf50; color: white; padding: 0.15rem 0.5rem; border-radius: 12px; font-size: 0.65rem; font-weight: 700; align-self: flex-start; margin-left: 0.5rem; line-height: 1; margin-top: 0.3rem;}

    /* üî• ‰∏âÊ¨ÑÈù¢Êùø */
    .panel {border-radius: 24px; display: flex; flex-direction: column; box-shadow: 0 12px 40px rgba(0,0,0,0.6); overflow: hidden;}
    .panel-header {color: #ffffff; font-size: 0.92rem; font-weight: 700; padding: 1rem 1rem 0.8rem; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.15);}
    .panel-content {flex: 1; overflow-y: auto; padding: 0.8rem 1rem; font-size: 0.76rem;}

    /* 1Ô∏è‚É£ ÈößÈÅìÁ∂úÂêà (ËóçËâ≤Á≥ª) */
    .tunnel-panel {background: #1c1c30; border: 1px solid #2f3250; color: #e3e8ff;}
    .tunnel-header {background: linear-gradient(135deg, #2d4373, #1a1f3d); color: #aad4ff;}
    .table-peak {font-size: 0.7rem; color: #ffc107; text-align: center; padding: 0.3rem 0;}
    .tunnel-row {display: grid; grid-template-columns: 2fr 1fr 1fr 1.2fr; gap: 0.3rem; align-items: center; padding: 0.5rem 0.3rem; margin-bottom: 0.2rem; border-radius: 8px;}
    .tunnel-row.header {background: #262647; font-weight: 600; color: #f3f6ff; position: sticky; top: 0; z-index: 1;}
    .tunnel-row.nth-child(even) {background: #222244;}
    .tunnel-row.nth-child(odd) {background: #292953;}
    .tunnel-name {font-weight: 700; font-size: 0.78rem; color: #fffceb;}
    .toll-cell {font-size: 0.7rem; text-align: center; padding: 0.2rem 0.4rem; background: #335599; color: #e0e0e0; border-radius: 6px;}
    .speed-cell {font-weight: 600; font-size: 0.75rem; padding: 0.2rem 0.4rem; border-radius: 8px; text-align: center;}
    .speed-good {background: #3a7d44; color: #c4efc4;}
    .speed-slow {background: #c08a00; color: #fff4b1;}
    .speed-congested {background: #a23939; color: #f7caca;}

    /* 2Ô∏è‚É£ ‰∏ªË¶ÅÈÅìË∑Ø (Á∂†Ëâ≤Á≥ª) */
    .road-panel {background: #1a2f2a; border: 1px solid #2f4a40; color: #d4f0d4;}
    .road-header {background: linear-gradient(135deg, #2d5a4a, #1a332e); color: #a8e6a8;}
    .road-item {display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 0; border-bottom: 1px solid rgba(255,255,255,0.12);}
    .road-name {font-weight: 600;}
    .road-speed {font-weight: 700; padding: 0.25rem 0.6rem; border-radius: 10px; min-width: 3.8rem; text-align: center;}

    /* 3Ô∏è‚É£ ‰∫§ÈÄöÊ∂àÊÅØ (Á¥ÖËâ≤Á≥ª) */
    .traffic-panel {background: #2a1717; border: 1px solid #4a2a2a; color: #ffd4d4;}
    .traffic-header {background: linear-gradient(135deg, #4a1f1f, #2a1717); color: #ffb3b3;}
    .traffic-item {padding: 0.7rem 0; border-bottom: 1px solid rgba(255,255,255,0.15); display: flex; align-items: flex-start; gap: 0.5rem;}
    .traffic-icon {font-size: 1.1rem; min-width: 1.3rem; flex-shrink: 0;}
    .traffic-text {flex: 1; line-height: 1.35;}
    .traffic-title {font-weight: 600; margin-bottom: 0.1rem; font-size: 0.75rem;}
    .traffic-time {color: rgba(255,230,240,0.85); font-size: 0.68rem;}

    .loading, .no-data {color: #888; text-align: center; padding: 2rem 1rem; font-style: italic;}
    .error {color: #ff6b6b; text-align: center; padding: 2rem 1rem; font-weight: 500;}
    
    /* Modal */
    .modal {display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(8px);}
    .modal-content {background: #1b1b24; margin: 2% auto; padding: 2.2rem 2.6rem; border-radius: 24px; width: 90%; max-width: 800px; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0,0,0,0.9); border: 1px solid #2f3148;}
    .modal-header {display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;}
    .close {color: #aaa; font-size: 2.2rem; font-weight: bold; cursor: pointer; line-height: 1; user-select: none;}
    .close:hover {color: #ffffff;}
    .modal-title {color: #ffffff; font-size: 1.35rem; font-weight: 700; margin: 0; flex: 1; margin-right: 1rem;}
    .modal-source {color: #ff8a80; font-size: 0.9rem; font-weight: 700; margin-top: 0.3rem;}
    .modal-time {color: #aaa; font-size: 0.82rem; margin-top: 0.2rem;}
    .modal-description {color: #e0e0e0; line-height: 1.5; font-size: 0.96rem; margin-top: 1.3rem; white-space: pre-wrap;}

    @media (max-width: 1200px) { .row1 { grid-template-columns: 1fr; height: auto; } .row2 { grid-template-columns: 1fr; height: auto; gap: 1rem; } .news-hero { font-size: 0.8rem; }}
</style>
</head>
<body>
<section class="row1">
    <div class="weather-hero">
        <div class="hero-title">OpenWeatherMap</div>
        <div class="weather-icon" id="weatherIcon">üå§Ô∏è</div>
        <div class="weather-temp" id="weatherTemp">--¬∞C</div>
        <div class="weather-desc" id="weatherDesc">--</div>
        <div class="weather-details" id="weatherDetails">Hong Kong</div>
        <div id="weatherWarning"></div>
    </div>
    <div class="news-hero">
        <div class="news-header">
            <div class="hero-title">Hong Kong News</div>
            <span id="newsCount">(0)</span>
        </div>
        <div id="heroNews"><div class="loading">Loading latest news...</div></div>
    </div>
</section>

<!-- üî• Á¨¨‰∫åË°å‰∏âÊ¨Ñ -->
<section class="row2">
    <!-- 1Ô∏è‚É£ ÈößÈÅìÁ∂úÂêà -->
    <div class="panel tunnel-panel">
        <div class="panel-header tunnel-header">üõ§Ô∏è Tunnel Status</div>
        <div class="table-peak" id="peakStatus">Loading...</div>
        <div class="panel-content" id="tunnelTable"><div class="no-data">Loading tunnels...</div></div>
    </div>
    
    <!-- 2Ô∏è‚É£ ‰∏ªË¶ÅÈÅìË∑ØËªäÈÄü -->
    <div class="panel road-panel">
        <div class="panel-header road-header">üõ£Ô∏è Major Roads</div>
        <div class="panel-content" id="majorRoadSpeeds"><div class="no-data">Loading roads...</div></div>
    </div>
    
    <!-- 3Ô∏è‚É£ ‰∫§ÈÄöÊ∂àÊÅØ -->
    <div class="panel traffic-panel">
        <div class="panel-header traffic-header">üö® Traffic News</div>
        <div class="panel-content" id="trafficNews"><div class="no-data">Loading traffic...</div></div>
    </div>
</section>

<div id="newsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div>
                <h2 class="modal-title" id="modalTitle">Loading...</h2>
                <div class="modal-source" id="modalSource"></div>
                <div class="modal-time" id="modalTime"></div>
            </div>
            <span class="close" id="modalClose">&times;</span>
        </div>
        <div class="modal-description" id="modalDescription"></div>
    </div>
</div>

<script>
const OW_API_KEY = 'f19c9c1cfbb572c048a0a99c38f012d2';
let newsData = [];

function kmhToMph(kmh){ return Math.round(kmh * 0.621371); }

// üî• 1Ô∏è‚É£ ÈößÈÅìÁ∂úÂêàË°®Ê†º
async function updateTunnelTable() {
    const container = document.getElementById('tunnelTable');
    const peakStatus = document.getElementById('peakStatus');
    const now = new Date();
    const isWeekday = now.getDay() !== 0 && now.getDay() !== 6;
    const hour = now.getHours(), minute = now.getMinutes();
    const isPeak = isWeekday && ((hour >= 7 && hour < 10) || (hour === 10 && minute <= 15) || (hour >= 16 && hour < 19));
    
    peakStatus.innerHTML = isPeak ? 'üî¥ <strong>Peak Hours</strong>' : 'üü¢ <strong>Off-Peak</strong>';
    
    const tolls = {
        'CHT': {private: isPeak ? 45 : 25, bus: isPeak ? 60 : 40, goods: isPeak ? 55 : 35},
        'WHC': {private: isPeak ? 70 : 50, bus: isPeak ? 90 : 70, goods: isPeak ? 80 : 60},
        'EHC': {private: isPeak ? 45 : 25, bus: isPeak ? 60 : 40, goods: isPeak ? 55 : 35}
    };
    
    try {
        const resp = await fetch('https://resource.data.one.gov.hk/td/traffic-speed-map/en/tunnels.json');
        const data = await resp.json();
        var speeds = {
            'CHT': {klnToHK: kmhToMph(data?.cht?.klnToHk?.speed || 45), hkToKln: kmhToMph(data?.cht?.hkToKln?.speed || 45)},
            'WHC': {klnToHK: kmhToMph(data?.whc?.klnToHk?.speed || 50), hkToKln: kmhToMph(data?.whc?.hkToKln?.speed || 50)},
            'EHC': {klnToHK: kmhToMph(data?.ehc?.klnToHk?.speed || 55), hkToKln: kmhToMph(data?.ehc?.hkToKln?.speed || 55)}
        };
    } catch(e) {
        speeds = {
            'CHT': {klnToHK: kmhToMph(35 + Math.random()*20), hkToKln: kmhToMph(42 + Math.random()*18)},
            'WHC': {klnToHK: kmhToMph(52 + Math.random()*15), hkToKln: kmhToMph(48 + Math.random()*12)},
            'EHC': {klnToHK: kmhToMph(58 + Math.random()*10), hkToKln: kmhToMph(62 + Math.random()*8)}
        };
    }
    
    let html = `
        <div class="tunnel-row header">
            <span>Tunnel</span><span>Car</span><span>Bus/Truck</span><span>Speed</span>
        </div>`;
    
    ['CHT','WHC','EHC'].forEach(t => {
        const fees = tolls[t], s = speeds[t];
        const avg = Math.round((s.klnToHK + s.hkToKln)/2);
        const cls = avg >= 31 ? 'speed-good' : avg >= 19 ? 'speed-slow' : 'speed-congested';
        html += `
            <div class="tunnel-row data">
                <span class="tunnel-name">${t}</span>
                <span class="toll-cell">$${fees.private}</span>
                <span class="toll-cell">$${fees.bus}/${fees.goods}</span>
                <span class="speed-cell ${cls}">${s.klnToHK}‚Üî${s.hkToKln}</span>
            </div>`;
    });
    container.innerHTML = html;
}

// üî• 2Ô∏è‚É£ ‰∏ªË¶ÅÈÅìË∑ØËªäÈÄü
async function updateMajorRoadSpeeds() {
    const container = document.getElementById('majorRoadSpeeds');
    const majorRoads = ['QSH', 'WKC', 'IEC', 'TKH', 'NTE', 'TME', 'KTE'];
    const roadNames = {'QSH':'Qing Sha Hwy', 'WKC':'West Kowloon Corridor', 'IEC':'Island Eastern Corridor', 'TKH':'Tsing Kwai Hwy', 'NTE':'North Lantau Hwy', 'TME':'Tsuen Mun Rd', 'KTE':'Kwun Tong Rd'};
    
    try {
        const resp = await fetch('https://resource.data.one.gov.hk/td/traffic-speed-map/en/roads.json');
        const data = await resp.json();
        
        let html = '';
        majorRoads.forEach(code => {
            const roadData = data[code];
            const speedKmh = roadData && roadData.length ? roadData[0].speed : null;
            const speedMph = speedKmh ? kmhToMph(speedKmh) : null;
            const cls = speedMph >= 31 ? 'speed-good' : speedMph >= 19 ? 'speed-slow' : 'speed-congested';
            
            html += `
                <div class="road-item">
                    <span class="road-name">${roadNames[code] || code}</span>
                    <span class="road-speed ${cls}">${speedMph || '--'}</span>
                </div>`;
        });
        container.innerHTML = html || '<div class="no-data">No road data</div>';
    } catch(e) {
        // Ê®°Êì¨‰∏ªË¶ÅÈÅìË∑ØÊï∏Êìö
        const mockSpeeds = [28, 35, 42, 25, 38, 32, 45];
        let html = '';
        majorRoads.forEach((code, i) => {
            const cls = mockSpeeds[i] >= 31 ? 'speed-good' : mockSpeeds[i] >= 19 ? 'speed-slow' : 'speed-congested';
            html += `
                <div class="road-item">
                    <span class="road-name">${roadNames[code] || code}</span>
                    <span class="road-speed ${cls}">${mockSpeeds[i]}</span>
                </div>`;
        });
        container.innerHTML = html;
    }
}

// üî• 3Ô∏è‚É£ ‰∫§ÈÄöÊ∂àÊÅØ
async function updateTrafficNews() {
    const container = document.getElementById('trafficNews');
    try {
        const resp = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent('https://resource.data.one.gov.hk/td/en/specialtrafficnews.xml'));
        const text = await resp.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(text, "text/xml");
        const items = xmlDoc.querySelectorAll('item');
        
        let html = '';
        Array.from(items).slice(0, 8).forEach(item => {
            let title = item.querySelector('title')?.textContent.trim() || '';
            if (title && /[A-Za-z]/.test(title)) {
                const pubDate = item.querySelector('pubDate') ? new Date(item.querySelector('pubDate').textContent) : new Date();
                let icon = 'üö®';
                if (title.toLowerCase().includes('tunnel')) icon = 'üöá';
                else if (title.toLowerCase().includes('road')) icon = 'üõ£Ô∏è';
                
                html += `
                    <div class="traffic-item">
                        <span class="traffic-icon">${icon}</span>
                        <div class="traffic-text">
                            <div class="traffic-title">${title}</div>
                            <div class="traffic-time">${pubDate.toLocaleTimeString('en-GB', {hour12: false})}</div>
                        </div>
                    </div>`;
            }
        });
        container.innerHTML = html || '<div class="no-data">No traffic alerts</div>';
    } catch(e) {
        container.innerHTML = '<div class="no-data">Traffic news unavailable</div>';
    }
}

// Â§©Ê∞£ + Êñ∞ËÅûÔºà‰∏çËÆäÔºâ
async function updateWeather() {
    try {
        const resp = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=22.3964&lon=114.1095&appid=${OW_API_KEY}&units=metric&lang=en`);
        const data = await resp.json();
        if (data.cod === 200) {
            const temp = Math.round(data.main.temp);
            const feelsLike = Math.round(data.main.feels_like);
            const humidity = data.main.humidity;
            const windSpeed = Math.round(data.wind.speed * 2.23694);
            const desc = data.weather[0].description.charAt(0).toUpperCase() + data.weather[0].description.slice(1);
            const iconCode = data.weather[0].icon;
            const iconMap = {'01d':'‚òÄÔ∏è','01n':'üåô','02d':'‚õÖ','02n':'‚õÖ','03d':'‚òÅÔ∏è','03n':'‚òÅÔ∏è','04d':'‚òÅÔ∏è','04n':'‚òÅÔ∏è','09d':'üå¶Ô∏è','09n':'üå¶Ô∏è','10d':'üåßÔ∏è','10n':'üåßÔ∏è','11d':'‚õàÔ∏è','11n':'‚õàÔ∏è','13d':'‚ùÑÔ∏è','13n':'‚ùÑÔ∏è','50d':'üå´Ô∏è','50n':'üå´Ô∏è'};
            document.getElementById('weatherIcon').textContent = iconMap[iconCode] || 'üå§Ô∏è';
            document.getElementById('weatherTemp').textContent = `${temp}¬∞C`;
            document.getElementById('weatherDesc').textContent = `${desc} ‚Ä¢ ${humidity}%`;
            document.getElementById('weatherDetails').textContent = `Feels ${feelsLike}¬∞C ‚Ä¢ Wind ${windSpeed}mph`;
            let warning = '';
            if (temp > 33) warning = 'Very Hot ‚òÄÔ∏è'; else if (temp < 12) warning = 'Very Cold ‚ùÑÔ∏è'; else if (humidity > 90) warning = 'Very Humid üíß'; else if (data.weather[0].main === 'Rain') warning = 'Rainy üåßÔ∏è';
            document.getElementById('weatherWarning').innerHTML = warning ? `<div class="weather-warning">${warning}</div>` : '';
        }
    } catch (e) { console.error(e); }
}

async function updateNews() {
    const newsContainer = document.getElementById('heroNews');
    const newsCountEl = document.getElementById('newsCount');
    newsContainer.innerHTML = '<div class="loading">Loading latest news...</div>';
    try {
        const resp = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent('https://www.scmp.com/rss/91/feed'));
        const text = await resp.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(text, "text/xml");
        const items = xmlDoc.querySelectorAll('item');
        newsData = [];
        let html = '';
        Array.from(items).slice(0, 12).forEach((item, i) => {
            const title = item.querySelector('title')?.textContent.trim() || '';
            const pubDate = item.querySelector('pubDate') ? new Date(item.querySelector('pubDate').textContent) : new Date();
            newsData.push({ title, pubDate, index: i });
            const titleShort = title.length > 80 ? title.substring(0, 80) + '...' : title;
            html += `<div class="news-item" onclick="openNewsModal(${i})">
                <div class="news-content">
                  <div class="news-title">${titleShort}</div>
                  <div class="news-source">SCMP</div>
                  <div class="news-time">${pubDate.toLocaleDateString('en-GB')}</div>
                </div>
                <span class="news-badge">NEW</span>
            </div>`;
        });
        newsContainer.innerHTML = html;
        newsCountEl.textContent = `(${newsData.length})`;
    } catch (e) {
        newsContainer.innerHTML = '<div class="error">News loading failed.</div>';
        console.error('News error:', e);
    }
}

function openNewsModal(idx) {
    if (newsData[idx]) {
        const news = newsData[idx];
        document.getElementById('modalTitle').textContent = news.title;
        document.getElementById('modalSource').textContent = 'SCMP';
        document.getElementById('modalTime').textContent = news.pubDate ? news.pubDate.toLocaleString('en-GB') : '';
        document.getElementById('modalDescription').textContent = 'Full article available on SCMP website.';
        document.getElementById('newsModal').style.display = 'block';
    }
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('modalClose').onclick = () => { document.getElementById('newsModal').style.display = 'none'; };
});
window.onclick = (event) => {
    const modal = document.getElementById('newsModal');
    if (event.target === modal) modal.style.display = 'none';
};

// üî• ÂïüÂãïÊâÄÊúâÊï∏Êìö
updateWeather();
updateNews();
updateTunnelTable();
updateMajorRoadSpeeds();
updateTrafficNews();

setInterval(updateWeather, 300000);           // Â§©Ê∞£5ÂàÜÈêò
setInterval(updateNews, 300000);              // Êñ∞ËÅû5ÂàÜÈêò
setInterval(updateTunnelTable, 30000);        // ÈößÈÅì30Áßí
setInterval(updateMajorRoadSpeeds, 30000);    // ÈÅìË∑Ø30Áßí
setInterval(updateTrafficNews, 120000);       // ‰∫§ÈÄö2ÂàÜÈêò
</script>
</body>
</html>
