<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hong Kong Street Lamp Map - Auto Detect CSV</title>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100vh; }
        #map { height: 100vh; width: 100%; }
        .controls { position: absolute; top: 15px; left: 15px; right: 15px; background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); padding: 25px; border-radius: 20px; box-shadow: 0 15px 50px rgba(0,0,0,0.3); z-index: 1000; max-width: 1200px; margin: 0 auto; }
        .title { margin: 0 0 15px 0; color: #2c3e50; font-size: 2em; font-weight: 800; text-align: center; }
        .search-box { width: 100%; padding: 16px 20px; border: 3px solid #e1e8ed; border-radius: 15px; font-size: 16px; margin-bottom: 15px; background: white; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .search-box:focus { border-color: #ff6b35; box-shadow: 0 0 0 4px rgba(255,107,53,0.2); transform: translateY(-2px); }
        #status { font-size: 1.1em; color: #666; margin-bottom: 15px; font-weight: 600; text-align: center; min-height: 30px; padding: 15px; background: rgba(255,255,255,0.8); border-radius: 12px; border-left: 5px solid #667eea; }
        .stats { display: flex; justify-content: center; gap: 25px; font-size: 1em; color: #666; flex-wrap: wrap; }
        .stats span { background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; padding: 12px 20px; border-radius: 30px; font-weight: 700; box-shadow: 0 5px 15px rgba(255,107,53,0.4); }
        .success { border-left-color: #27ae60 !important; background: rgba(40,167,105,0.1) !important; color: #27ae60 !important; }
        .error { border-left-color: #e53e3e !important; background: rgba(220,53,69,0.1) !important; color: #e53e3e !important; }
        .file-list { background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 10px 0; max-height: 200px; overflow-y: auto; }
        .file-item { padding: 8px; margin: 5px 0; background: white; border-radius: 6px; cursor: pointer; border-left: 4px solid #667eea; }
        .file-item:hover { background: #e6f3ff; }
        .btn { background: #ff6b35; color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 700; margin: 10px 5px 0 0; box-shadow: 0 4px 12px rgba(255,107,53,0.3); }
        .btn:hover { background: #e55a2b; transform: translateY(-2px); }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div id="map"></div>
    <div class="controls">
        <h1 class="title">ğŸª” Hong Kong Street Lamp Map</h1>
        <div id="status" class="error">ğŸ” Scanning for CSV files...</div>
        <div id="file-list" class="file-list" style="display: none;"></div>
        <input type="text" class="search-box" id="search" placeholder="ğŸ” Search after loading..." disabled>
        <div class="stats">
            <span id="total-count">0</span>
            <span id="district-count">0</span>
            <span id="update-time">-</span>
        </div>
    </div>

    <script>
        const map = L.map('map').setView([22.3193, 114.1694], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap | Highways Department [web:1]'
        }).addTo(map);

        let allMarkers = L.layerGroup().addTo(map);
        let filteredMarkers = L.layerGroup().addTo(map);
        let lampData = [];
        let markerCache = new Map();

        // ğŸ”¥ è‡ªå‹•æƒææ‰€æœ‰CSVæª”æ¡ˆ
        async function scanCSVFiles() {
            const statusEl = document.getElementById('status');
            const fileListEl = document.getElementById('file-list');
            
            const csvNames = [
                'lamppost_en.csv', 'lamppost.csv', 'streetlamp.csv', 'lamp.csv',
                'lamppost_en.CSV', 'LAMPOST_EN.CSV', 'lampposts.csv'
            ];
            
            statusEl.textContent = 'ğŸ” Scanning folder for CSV files...';
            fileListEl.style.display = 'block';
            fileListEl.innerHTML = '';
            
            let foundFiles = [];
            
            for (let csvName of csvNames) {
                try {
                    const response = await fetch(csvName);
                    if (response.ok) {
                        foundFiles.push(csvName);
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.innerHTML = `âœ… <strong>${csvName}</strong> <button class="btn" onclick="loadSpecificFile('${csvName}')">Load This File</button>`;
                        fileListEl.appendChild(fileItem);
                    }
                } catch (e) {
                    console.log(`No ${csvName}`);
                }
            }
            
            if (foundFiles.length > 0) {
                statusEl.className = 'success';
                statusEl.innerHTML = `âœ… Found ${foundFiles.length} CSV file(s)! Click to load.`;
                // è‡ªå‹•è¼‰å…¥ç¬¬ä¸€å€‹æ‰¾åˆ°çš„æª”æ¡ˆ
                loadSpecificFile(foundFiles[0]);
            } else {
                statusEl.className = 'error';
                statusEl.innerHTML = `
                    âŒ No CSV files found!<br>
                    ğŸ“¥ <strong>Download:</strong> <a href="https://plis.hyd.gov.hk/datagovhk/plis/lamppost_en.csv" target="_blank" style="color: #ff6b35;">lamppost_en.csv</a><br>
                    ğŸ’¾ Save as <code>lamppost_en.csv</code> in same folder as index.html
                `;
            }
        }

        async function loadSpecificFile(filename) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = `ğŸ“Š Loading ${filename}...`;
            statusEl.className = '';
            
            try {
                const response = await fetch(filename);
                const csvText = await response.text();
                
                statusEl.textContent = 'ğŸ“Š Parsing CSV...';
                const parsed = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: { LATITUDE: true, LONGITUDE: true }
                });
                
                lampData = parsed.data.filter(row => {
                    const lat = parseFloat(row.LATITUDE);
                    const lng = parseFloat(row.LONGITUDE);
                    return lat && lng && !isNaN(lat) && !isNaN(lng) &&
                           lat > 22.1 && lat < 22.6 && lng > 113.8 && lng < 114.5;
                }).slice(0, 80000);
                
                // æ¸…ç©ºä¸¦é‡å»º
                markerCache.clear();
                allMarkers.clearLayers();
                filteredMarkers.clearLayers();
                
                statusEl.textContent = `ğŸ—ºï¸ Creating ${lampData.length.toLocaleString()} markers...`;
                lampData.forEach(createMarker);
                
                updateStats();
                statusEl.innerHTML = `âœ… <strong>SUCCESS!</strong> Loaded ${lampData.length.toLocaleString()} street lamps from ${filename}`;
                statusEl.className = 'success';
                
                document.getElementById('search').disabled = false;
                map.fitBounds(filteredMarkers.getBounds(), { padding: [40, 40], maxZoom: 13 });
                
            } catch (error) {
                statusEl.textContent = `âŒ Failed to load ${filename}`;
                statusEl.className = 'error';
            }
        }

        function createMarker(row) {
            const latlng = [parseFloat(row.LATITUDE), parseFloat(row.LONGITUDE)];
            if (isNaN(latlng[0]) || isNaN(latlng[1]) || markerCache.has(row.LAMP_NO)) return;
            
            const marker = L.circleMarker(latlng, {
                radius: 3,
                fillColor: '#ff6b35',
                color: '#ffffff',
                weight: 1.5,
                fillOpacity: 0.9
            });
            
            marker.bindPopup(`
                <div style="min-width: 320px;">
                    <h3 style="margin: 0 0 12px 0;">ğŸª” Lamp <strong>${row.LAMP_NO}</strong></h3>
                    <strong>${row.DISTRICT}</strong><br>
                    ${row.STREET} - ${row.LOCATION}<br>
                    ğŸ“ ${latlng[0].toFixed(5)}, ${latlng[1].toFixed(5)}
                </div>
            `);
            
            markerCache.set(row.LAMP_NO, marker);
            filteredMarkers.addLayer(marker);
            allMarkers.addLayer(marker);
        }

        function updateStats() {
            const districts = [...new Set(lampData.map(d => d.DISTRICT).filter(Boolean))];
            document.getElementById('total-count').textContent = `${lampData.length.toLocaleString()}`;
            document.getElementById('district-count').textContent = `${districts.length}`;
            document.getElementById('update-time').textContent = new Date().toLocaleTimeString();
        }

        document.getElementById('search').addEventListener('input', e => {
            const query = e.target.value.toLowerCase();
            filteredMarkers.clearLayers();
            
            if (!query) {
                markerCache.forEach(m => filteredMarkers.addLayer(m));
                return;
            }
            
            const matches = lampData.filter(row => 
                Object.values(row).some(val => 
                    val?.toString().toLowerCase().includes(query)
                )
            );
            
            matches.slice(0, 3000).forEach(row => {
                const marker = markerCache.get(row.LAMP_NO);
                if (marker) filteredMarkers.addLayer(marker);
            });
            
            document.getElementById('status').textContent = `ğŸ” ${matches.length.toLocaleString()} results`;
        });

        L.control.scale({ metric: true }).addTo(map);
        
        // å•Ÿå‹•æƒæ
        scanCSVFiles();
    </script>
</body>
</html>
