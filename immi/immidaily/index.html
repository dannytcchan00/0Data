<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hong Kong Border Control Flow - Dark Edition</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #e8e8e8;
            overflow: hidden;
        }
        #map { 
            height: 100vh; 
            width: 100%; 
            filter: contrast(1.1) saturate(1.2);
        }
        
        /* Dark glass panels */
        .panel {
            position: absolute; 
            background: rgba(15, 15, 25, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 
                0 25px 45px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255,255,255,0.05),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }
        
        .info { 
            top: 25px; left: 25px; 
            z-index: 1000; 
            padding: 25px; 
            width: 380px;
            font-size: 15px;
            line-height: 1.6;
        }
        .info h2 { 
            margin: 0 0 20px 0; 
            color: #4fc3f7; 
            font-weight: 600;
            font-size: 22px;
            text-shadow: 0 2px 10px rgba(79,195,247,0.3);
        }
        .stats { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            margin-top: 15px;
        }
        .stat-item {
            background: rgba(30, 30, 40, 0.6);
            padding: 12px 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .stat-number { font-size: 24px; font-weight: 600; color: #4ade80; margin-bottom: 4px; }
        .stat-label { font-size: 13px; color: #a1a1aa; }
        
        .legend { 
            bottom: 25px; right: 25px; 
            padding: 20px; 
            width: 200px;
            font-size: 13px;
        }
        .legend-item { 
            display: flex; align-items: center; 
            margin: 12px 0; 
            font-weight: 500;
        }
        .legend-color { 
            width: 16px; height: 16px; 
            margin-right: 12px; 
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        
        .loading { 
            color: #a1a1aa; 
            font-style: italic;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        /* Custom Leaflet dark theme */
        .leaflet-popup-content-wrapper {
            background: rgba(20, 20, 30, 0.98);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
        }
        .leaflet-popup-content { 
            margin: 15px 20px 10px; 
            color: #e8e8e8;
            font-family: 'Inter', sans-serif;
        }
        .leaflet-popup-tip { box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="panel info">
        <h2>ðŸ›‚ Border Control Monitor</h2>
        <div class="loading" id="status">Loading Immigration Department data...</div>
        <div class="stats" id="liveStats" style="display: none;">
            <div class="stat-item">
                <div class="stat-number" id="totalArrivals">-</div>
                <div class="stat-label">Avg Daily Arrivals</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalDepartures">-</div>
                <div class="stat-label">Avg Daily Departures</div>
            </div>
        </div>
        <small style="color: #71717a; margin-top: 15px; display: block;">Data: Immigration Department [attached_file:1]</small>
    </div>
    
    <div class="panel legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #ff4444;"></div>
            Airport
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ffaa00;"></div>
            Land Borders
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #44ff44;"></div>
            Ferry Terminals
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        // Control points with precise coordinates [web:2]
        const controlPoints = {
            'Airport': { coords: [22.30889, 113.91444], colour: '#ff4444', type: 'airport' },
            'Lo Wu': { coords: [22.53222, 114.11333], colour: '#ffaa00', type: 'land' },
            'Lok Ma Chau': { coords: [22.52074, 114.07496], colour: '#ffaa00', type: 'land' },
            'Lok Ma Chau Spur Line': { coords: [22.51577, 114.06877], colour: '#ffaa00', type: 'land' },
            'Man Kam To': { coords: [22.5370, 114.1294], colour: '#ffaa00', type: 'land' },
            'Sha Tau Kok': { coords: [22.54911, 114.22328], colour: '#ffaa00', type: 'land' },
            'Shenzhen Bay': { coords: [22.5039, 113.9447], colour: '#ffaa00', type: 'land' },
            'Hong Kong-Zhuhai-Macao Bridge': { coords: [22.28306, 113.78056], colour: '#ffaa00', type: 'land' },
            'Heung Yuen Wai': { coords: [22.55429, 114.15242], colour: '#ffaa00', type: 'land' },
            'Express Rail Link West Kowloon': { coords: [22.30361, 114.16500], colour: '#ffaa00', type: 'rail' },
            'China Ferry Terminal': { coords: [22.29931, 114.16725], colour: '#44ff44', type: 'ferry' },
            'Macau Ferry Terminal': { coords: [22.28937, 114.15215], colour: '#44ff44', type: 'ferry' },
            'Kai Tak Cruise Terminal': { coords: [22.3074, 114.2128], colour: '#44ff44', type: 'ferry' },
            'Hung Hom': { coords: [22.302, 114.179], colour: '#ffaa00', type: 'rail' },
            'Tuen Mun Ferry Terminal': { coords: [22.392, 113.978], colour: '#44ff44', type: 'ferry' },
            'Harbour Control': { coords: [22.290, 114.160], colour: '#44ff44', type: 'ferry' }
        };

        // Dark CartoDB basemap
        const map = L.map('map').setView([22.35, 114.1], 10);
        L.tileLayer('https://cartodb-basemaps-c.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap Â© CartoDB',
            maxZoom: 19
        }).addTo(map);

        let latestData = {};
        let totalArrivals = 0, totalDepartures = 0;

        // Load CSV data
        Papa.parse('https://dannytcchan00.github.io/0Data/data/immi/immi_daily/data.csv', {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                const df = results.data.reverse(); // Latest first
                const recentRecords = df.slice(0, 7 * 32); // Recent 7 days
                
                recentRecords.forEach(row => {
                    if (!row['Control Point'] || !row['Total'] || row['Total'] === '0') return;
                    const point = row['Control Point'];
                    const total = parseInt(row['Total']) || 0;
                    const direction = row['Arrival / Departure'];
                    
                    if (!latestData[point]) {
                        latestData[point] = { arrivals: 0, departures: 0, total: 0, count: 0 };
                    }
                    latestData[point][direction.toLowerCase()] += total;
                    latestData[point].total += total;
                    latestData[point].count += 1;
                    
                    totalArrivals += direction === 'Arrival' ? total : 0;
                    totalDepartures += direction === 'Departure' ? total : 0;
                });

                // Calculate averages
                Object.keys(latestData).forEach(point => {
                    const data = latestData[point];
                    data.avgArrivals = Math.round(data.arrivals / data.count);
                    data.avgDepartures = Math.round(data.departures / data.count);
                    data.avgTotal = Math.round(data.total / data.count);
                });

                updateUI();
                addMarkers();
            }
        });

        function updateUI() {
            document.getElementById('status').style.display = 'none';
            document.getElementById('liveStats').style.display = 'grid';
            document.getElementById('totalArrivals').textContent = totalArrivals.toLocaleString();
            document.getElementById('totalDepartures').textContent = totalDepartures.toLocaleString();
        }

        function addMarkers() {
            Object.entries(controlPoints).forEach(([name, info]) => {
                const data = latestData[name];
                if (!data) return;
                
                const popupContent = `
                    <div style="font-family: 'Inter', sans-serif; line-height: 1.6;">
                        <h3 style="margin: 0 0 15px 0; color: ${info.colour}; font-size: 20px; font-weight: 600;">${name}</h3>
                        <div style="background: rgba(40,40,50,0.5); padding: 12px; border-radius: 10px; margin: 10px 0;">
                            <div style="font-size: 18px; color: #4ade80; font-weight: 600;">${data.avgArrivals.toLocaleString()}</div>
                            <div style="font-size: 13px; color: #a1a1aa;">Avg Daily Arrivals</div>
                        </div>
                        <div style="background: rgba(40,40,50,0.5); padding: 12px; border-radius: 10px; margin: 10px 0;">
                            <div style="font-size: 18px; color: #f87171; font-weight: 600;">${data.avgDepartures.toLocaleString()}</div>
                            <div style="font-size: 13px; color: #a1a1aa;">Avg Daily Departures</div>
                        </div>
                        <hr style="border-color: rgba(255,255,255,0.1); margin: 15px 0;">
                        <div><strong>Total:</strong> ${data.avgTotal.toLocaleString()} (past ${data.count} records)</div>
                    </div>
                `;
                
                const marker = L.circleMarker(info.coords, {
                    radius: 10,
                    fillColor: info.colour,
                    color: '#ffffff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.85
                }).addTo(map)
                .bindPopup(popupContent, { maxWidth: 320, className: 'dark-popup' })
                .bindTooltip(`<strong>${name}</strong><br>${data.avgTotal.toLocaleString()} total`, {
                    direction: 'top', className: 'dark-tooltip'
                });
            });
        }
    </script>
</body>
</html>
