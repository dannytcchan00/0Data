<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hong Kong Border Flow - å³æ™‚å¤©æ°£</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #e8e8e8; overflow: hidden;
        }
        #map { height: 100vh; width: 100%; filter: contrast(1.1) saturate(1.2); }
        
        .panel {
            position: absolute; background: rgba(15,15,25,0.95);
            backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; box-shadow: 0 25px 45px rgba(0,0,0,0.4);
        }
        
        .top-left { top: 25px; left: 25px; width: 420px; padding: 25px; z-index: 1000; }
        .top-right { top: 25px; right: 25px; width: 280px; padding: 25px; z-index: 1000; }
        
        .top-left h2, .top-right h3 { margin: 0 0 20px 0; color: #4fc3f7; font-size: 24px; font-weight: 700; }
        .top-right h3 { font-size: 20px; }
        
        .status-bar { 
            background: rgba(30,30,40,0.8); border-radius: 12px; padding: 12px; 
            margin: 15px 0; font-size: 14px; color: #10b981;
        }
        .date-picker { 
            background: rgba(30,30,40,0.8); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 12px 16px; margin: 15px 0; color: #e8e8e8;
            font-size: 15px; width: 100%;
        }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; margin-top: 15px; }
        .stat-card { 
            background: linear-gradient(145deg, rgba(40,40,60,0.8), rgba(25,25,40,0.8));
            padding: 20px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-number { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .hk { color: #3b82f6; } .cn { color: #ef4444; } .other { color: #10b981; }
        .stat-label { font-size: 13px; color: #a1a1aa; }
        
        /* Weather styling */
        .weather-now { text-align: center; margin-bottom: 20px; }
        .weather-temp { font-size: 36px; font-weight: 700; color: #4fc3f7; margin: 0; }
        .weather-desc { font-size: 16px; color: #a1a1aa; margin: 5px 0 0 0; }
        .weather-icon { font-size: 48px; margin-bottom: 10px; }
        .time-hk { font-size: 18px; font-weight: 600; color: #10b981; margin-bottom: 10px; }
        .csv-status { font-size: 13px; color: #a1a1aa; }
        
        .legend { bottom: 25px; right: 25px; padding: 20px; width: 240px; font-size: 14px; }
        .legend-item { display: flex; align-items: center; margin: 12px 0; font-weight: 500; }
        .legend-color { width: 16px; height: 16px; margin-right: 12px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        
        /* Enhanced popup - Latest + Latest 7-day avg */
        .leaflet-popup-content-wrapper { 
            background: rgba(15,15,25,0.98); border-radius: 20px; border: 1px solid rgba(255,255,255,0.15);
            backdrop-filter: blur(25px); max-width: 420px; margin: 10px; max-height: 480px; overflow-y: auto;
        }
        .leaflet-popup-content { margin: 0; padding: 25px; color: #e8e8e8; font-family: 'Inter', sans-serif; line-height: 1.5; }
        .popup-title { color: #4fc3f7; font-size: 22px; font-weight: 700; margin: 0 0 20px 0; }
        .data-section { margin: 16px 0; padding: 18px; background: rgba(40,40,60,0.7); border-radius: 14px; border: 1px solid rgba(255,255,255,0.08); }
        .data-title { font-size: 15px; font-weight: 600; margin-bottom: 12px; color: #e8e8e8; }
        .data-title.today { color: #10b981; } .data-title.avg { color: #f59e0b; }
        .category-row { display: flex; justify-content: space-between; align-items: center; margin: 8px 0; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .category-row:last-child { border-bottom: none; }
        .category-label { font-weight: 500; }
        .hk-label { color: #3b82f6; } .cn-label { color: #ef4444; } .other-label { color: #10b981; }
        .category-number { font-size: 18px; font-weight: 700; }
        .hk-num { color: #3b82f6; } .cn-num { color: #ef4444; } .other-num { color: #10b981; }
        .total-row { margin-top: 12px; padding-top: 12px; border-top: 2px solid rgba(79,195,247,0.3); }
        .total-label { font-weight: 600; color: #4fc3f7; }
        .total-number { font-size: 20px; color: #4fc3f7; }
        .date-note { font-size: 13px; color: #a1a1aa; margin-top: 15px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Left panel - Stats -->
    <div class="panel top-left">
        <h2>ğŸ›‚ ä¸‰é¡äººæµç¸½è¨ˆ</h2>
        <div class="status-bar" id="statusBar">
            <span id="lastUpdate">Syncing CSV data...</span>
            <span id="recordCount">-</span>
        </div>
        <input type="text" class="date-picker" id="datePicker" placeholder="Select historical date">
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number hk" id="totalTodayHK">-</div>
                <div class="stat-label">ğŸ‡­ğŸ‡° HK Residents</div>
            </div>
            <div class="stat-card">
                <div class="stat-number cn" id="totalTodayCN">-</div>
                <div class="stat-label">ğŸ‡¨ğŸ‡³ Mainland</div>
            </div>
            <div class="stat-card">
                <div class="stat-number other" id="totalTodayOther">-</div>
                <div class="stat-label">ğŸŒ Others</div>
            </div>
        </div>
    </div>
    
    <!-- Right panel - HK Time + Weather -->
    <div class="panel top-right">
        <h3>ğŸŒ¤ï¸ é¦™æ¸¯å³æ™‚å¤©æ°£</h3>
        <div class="time-hk" id="hkTime">--:--</div>
        <div class="weather-now">
            <div class="weather-icon" id="weatherIcon">ğŸŒ¤ï¸</div>
            <div class="weather-temp" id="weatherTemp">--Â°C</div>
            <div class="weather-desc" id="weatherDesc">Loading...</div>
        </div>
        <div class="csv-status" id="csvStatus">CSV: Loading...</div>
    </div>
    
    <div class="panel legend">
        <div class="legend-item"><div class="legend-color" style="background:#ff4444;"></div>ğŸ›©ï¸ Airport</div>
        <div class="legend-item"><div class="legend-color" style="background:#ffaa00;"></div>ğŸŒ‰ Land</div>
        <div class="legend-item"><div class="legend-color" style="background:#44ff44;"></div>ğŸš¢ Ferry</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        const CSV_URL = 'https://dannytcchan00.github.io/0Data/data/immi/immi_daily/data.csv';
        
        const controlPoints = {
            'Airport': { coords: [22.30889, 113.91444], colour: '#ff4444' },
            'Lo Wu': { coords: [22.53222, 114.11333], colour: '#ffaa00' },
            'Lok Ma Chau': { coords: [22.52074, 114.07496], colour: '#ffaa00' },
            'Lok Ma Chau Spur Line': { coords: [22.51577, 114.06877], colour: '#ffaa00' },
            'Man Kam To': { coords: [22.5370, 114.1294], colour: '#ffaa00' },
            'Sha Tau Kok': { coords: [22.54911, 114.22328], colour: '#ffaa00' },
            'Shenzhen Bay': { coords: [22.5039, 113.9447], colour: '#ffaa00' },
            'Hong Kong-Zhuhai-Macao Bridge': { coords: [22.28306, 113.78056], colour: '#ffaa00' },
            'Heung Yuen Wai': { coords: [22.55429, 114.15242], colour: '#ffaa00' },
            'Express Rail Link West Kowloon': { coords: [22.30361, 114.16500], colour: '#ffaa00' },
            'China Ferry Terminal': { coords: [22.29931, 114.16725], colour: '#44ff44' },
            'Macau Ferry Terminal': { coords: [22.28937, 114.15215], colour: '#44ff44' },
            'Kai Tak Cruise Terminal': { coords: [22.3074, 114.2128], colour: '#44ff44' },
            'Hung Hom': { coords: [22.302, 114.179], colour: '#ffaa00' },
            'Tuen Mun Ferry Terminal': { coords: [22.392, 113.978], colour: '#44ff44' },
            'Harbour Control': { coords: [22.290, 114.160], colour: '#44ff44' }
        };

        const map = L.map('map').setView([22.35, 114.1], 10);
        L.tileLayer('https://cartodb-basemaps-c.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap Â© CartoDB', maxZoom: 19
        }).addTo(map);

        let allData = [], latestData = {}, latest7Avg = {}, selectedData = {}, selectedDate = '';
        let markers = {}, lastSyncTime = null;

        // HK Time
        function updateHKTime() {
            const now = new Date().toLocaleString('zh-HK', { 
                timeZone: 'Asia/Hong_Kong',
                weekday: 'short', year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
            document.getElementById('hkTime').textContent = now;
        }

        // HK Weather (OpenWeatherMap free API)
        async function updateWeather() {
            try {
                const response = await fetch('https://api.openweathermap.org/data/2.5/weather?q=Hong+Kong&appid=1d6d5b7a8b8c4f8e9a0b1c2d3e4f5a6b&units=metric');
                const data = await response.json();
                document.getElementById('weatherTemp').textContent = `${Math.round(data.main.temp)}Â°C`;
                document.getElementById('weatherDesc').textContent = data.weather[0].description;
                document.getElementById('weatherIcon').textContent = getWeatherIcon(data.weather[0].icon);
            } catch(e) {
                document.getElementById('weatherTemp').textContent = '--Â°C';
                document.getElementById('weatherDesc').textContent = 'Weather unavailable';
            }
        }
        function getWeatherIcon(icon) {
            const icons = {
                '01d': 'â˜€ï¸', '01n': 'ğŸŒ™', '02d': 'â›…', '02n': 'ğŸŒ¤ï¸',
                '03d': 'â˜ï¸', '03n': 'â˜ï¸', '04d': 'â˜ï¸', '04n': 'â˜ï¸',
                '09d': 'ğŸŒ¦ï¸', '09n': 'ğŸŒ¦ï¸', '10d': 'ğŸŒ§ï¸', '10n': 'ğŸŒ§ï¸',
                '11d': 'â›ˆï¸', '11n': 'â›ˆï¸', '13d': 'â„ï¸', '13n': 'â„ï¸',
                '50d': 'ğŸŒ«ï¸', '50n': 'ğŸŒ«ï¸'
            };
            return icons[icon] || 'ğŸŒ¤ï¸';
        }

        async function syncCSV() {
            document.getElementById('statusBar').innerHTML = '<span class="loading">ğŸ”„ Syncing live data...</span>';
            document.getElementById('csvStatus').textContent = 'CSV: Syncing...';
            
            Papa.parse(CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    allData = results.data.reverse();
                    document.getElementById('recordCount').textContent = `${allData.length.toLocaleString()} records`;
                    document.getElementById('lastUpdate').textContent = `Last sync: ${new Date().toLocaleString('en-GB', {timeZone: 'Asia/Hong_Kong'})}`;
                    document.getElementById('csvStatus').textContent = `CSV: Latest ${allData[0]?.Date || 'N/A'}`;
                    
                    processLatestData();
                    if (selectedDate) loadSelectedDate(selectedDate);
                }
            });
        }

        function processLatestData() {
            // Latest data (first record per control point)
            const seenPoints = new Set();
            latestData = {};
            allData.slice(0, 100).forEach(row => {
                const point = row['Control Point'];
                if (!point || seenPoints.has(point)) return;
                seenPoints.add(point);
                
                latestData[point] = {
                    hk: {arrivals: 0, departures: 0},
                    cn: {arrivals: 0, departures: 0},
                    other: {arrivals: 0, departures: 0}
                };
                
                const nums = {
                    hk: parseInt(row['Hong Kong Residents']) || 0,
                    cn: parseInt(row['Mainland Visitors']) || 0,
                    other: parseInt(row['Other Visitors']) || 0
                };
                
                const dir = row['Arrival / Departure'].toLowerCase();
                Object.keys(nums).forEach(cat => {
                    latestData[point][cat][dir + 's'] += nums[cat];
                });
            });

            // Latest 7-day average (first 7 days of data)
            const recentRecords = allData.slice(0, 224);
            const avgRecords = {};
            recentRecords.forEach(row => {
                const point = row['Control Point'];
                if (!point) return;
                if (!avgRecords[point]) avgRecords[point] = {
                    hk: {arrivals: 0, departures: 0, count: 0},
                    cn: {arrivals: 0, departures: 0, count: 0},
                    other: {arrivals: 0, departures: 0, count: 0}
                };
                
                const nums = {
                    hk: parseInt(row['Hong Kong Residents']) || 0,
                    cn: parseInt(row['Mainland Visitors']) || 0,
                    other: parseInt(row['Other Visitors']) || 0
                };
                
                const dir = row['Arrival / Departure'].toLowerCase();
                Object.keys(nums).forEach(cat => {
                    avgRecords[point][cat][dir + 's'] += nums[cat];
                    avgRecords[point][cat].count++;
                });
            });
            
            latest7Avg = {};
            Object.keys(avgRecords).forEach(point => {
                latest7Avg[point] = {};
                ['hk', 'cn', 'other'].forEach(cat => {
                    const data = avgRecords[point][cat];
                    latest7Avg[point][cat] = {
                        arrivals: Math.round(data.arrivals / data.count),
                        departures: Math.round(data.departures / data.count)
                    };
                });
            });

            updateTotalStats();
            updateMarkers();
        }

        function updateTotalStats() {
            let totalHK = 0, totalCN = 0, totalOther = 0;
            Object.values(latestData).forEach(d => {
                totalHK += d.hk.arrivals + d.hk.departures;
                totalCN += d.cn.arrivals + d.cn.departures;
                totalOther += d.other.arrivals + d.other.departures;
            });
            document.getElementById('totalTodayHK').textContent = totalHK.toLocaleString();
            document.getElementById('totalTodayCN').textContent = totalCN.toLocaleString();
            document.getElementById('totalTodayOther').textContent = totalOther.toLocaleString();
        }

        function updateMarkers() {
            Object.entries(controlPoints).forEach(([name, info]) => {
                const latest = latestData[name] || {hk:{arrivals:0,departures:0}, cn:{arrivals:0,departures:0}, other:{arrivals:0,departures:0}};
                const avg7 = latest7Avg[name] || latest;

                const popupContent = `
                    <div>
                        <h3 class="popup-title" style="color:${info.colour};">${name}</h3>
                        
                        <div class="data-section">
                            <div class="data-title today">ğŸ“… Latest Data</div>
                            <div class="category-row">
                                <span class="category-label hk-label">ğŸ‡­ğŸ‡° HK Residents</span>
                                <span class="category-number hk-num">${latest.hk.arrivals.toLocaleString()}â†— ${latest.hk.departures.toLocaleString()}â†˜</span>
                            </div>
                            <div class="category-row">
                                <span class="category-label cn-label">ğŸ‡¨ğŸ‡³ Mainland</span>
                                <span class="category-number cn-num">${latest.cn.arrivals.toLocaleString()}â†— ${latest.cn.departures.toLocaleString()}â†˜</span>
                            </div>
                            <div class="category-row">
                                <span class="category-label other-label">ğŸŒ Others</span>
                                <span class="category-number other-num">${latest.other.arrivals.toLocaleString()}â†— ${latest.other.departures.toLocaleString()}â†˜</span>
                            </div>
                            <div class="category-row total-row">
                                <span class="total-label">ğŸ’ Total</span>
                                <span class="total-number">${(latest.hk.arrivals + latest.cn.arrivals + latest.other.arrivals + latest.hk.departures + latest.cn.departures + latest.other.departures).toLocaleString()}</span>
                            </div>
                        </div>
                        
                        <div class="data-section">
                            <div class="data-title avg">ğŸ“Š Latest 7-Day Avg</div>
                            <div class="category-row">
                                <span class="category-label hk-label">ğŸ‡­ğŸ‡° HK Residents</span>
                                <span class="category-number hk-num">${avg7.hk.arrivals.toLocaleString()}â†— ${avg7.hk.departures.toLocaleString()}â†˜</span>
                            </div>
                            <div class="category-row">
                                <span class="category-label cn-label">ğŸ‡¨ğŸ‡³ Mainland</span>
                                <span class="category-number cn-num">${avg7.cn.arrivals.toLocaleString()}â†— ${avg7.cn.departures.toLocaleString()}â†˜</span>
                            </div>
                            <div class="category-row">
                                <span class="category-label other-label">ğŸŒ Others</span>
                                <span class="category-number other-num">${avg7.other.arrivals.toLocaleString()}â†— ${avg7.other.departures.toLocaleString()}â†˜</span>
                            </div>
                        </div>
                        
                        <div class="date-note">ğŸŒ Live CSV sync â€¢ Right panel: HK time + weather</div>
                    </div>
                `;

                if (markers[name]) {
                    markers[name].setPopupContent(popupContent);
                } else {
                    markers[name] = L.circleMarker(info.coords, {
                        radius: 14, fillColor: info.colour, color: '#ffffff', 
                        weight: 3, opacity: 1, fillOpacity: 0.85
                    }).addTo(map)
                    .bindPopup(popupContent, { maxWidth: 420, className: 'custom-popup' });
                }
            });
        }

        // Initialize
        setInterval(updateHKTime, 1000);
        updateHKTime();
        updateWeather();
        setInterval(updateWeather, 10 * 60 * 1000); // 10 min
        
        syncCSV();
        setInterval(syncCSV, 5 * 60 * 1000); // 5 min
    </script>
</body>
</html>
