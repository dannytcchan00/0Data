<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hong Kong Border Control Flow Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a; 
            color: #e0e0e0; 
        }
        #map { height: 100vh; width: 100%; }
        .info { 
            position: absolute; 
            top: 15px; left: 15px; 
            z-index: 1000; 
            background: rgba(20,20,20,0.95); 
            backdrop-filter: blur(10px);
            padding: 15px 20px; 
            border-radius: 12px; 
            border: 1px solid #333;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            max-width: 350px;
            font-size: 14px;
        }
        .info h3 { margin: 0 0 10px 0; color: #4fc3f7; }
        .loading { color: #888; }
        .legend { 
            position: absolute; bottom: 20px; right: 20px; 
            background: rgba(20,20,20,0.95); 
            padding: 15px; border-radius: 12px; border: 1px solid #333;
            font-size: 12px;
        }
        .legend div { display: flex; align-items: center; margin: 5px 0; }
        .legend span { width: 20px; height: 12px; margin-right: 8px; border-radius: 2px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="info">
        <h3>Border Control Flow Monitor</h3>
        <div class="loading" id="status">Loading data from Immigration Department...</div>
    </div>
    <div class="legend">
        <div><span style="background:#ff4444;"></span>Airport</div>
        <div><span style="background:#ffaa00;"></span>Land Borders</div>
        <div><span style="background:#44ff44;"></span>Ferry Terminals</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        // Hong Kong control points coordinates [web:2][web:6]
        const controlPoints = {
            'Airport': { coords: [22.30889, 113.91444], colour: '#ff4444' },
            'Lo Wu': { coords: [22.53222, 114.11333], colour: '#ffaa00' },
            'Lok Ma Chau': { coords: [22.52074, 114.07496], colour: '#ffaa00' },
            'Lok Ma Chau Spur Line': { coords: [22.51577, 114.06877], colour: '#ffaa00' },
            'Man Kam To': { coords: [22.5370, 114.1294], colour: '#ffaa00' },
            'Sha Tau Kok': { coords: [22.54911, 114.22328], colour: '#ffaa00' },
            'Shenzhen Bay': { coords: [22.5039, 113.9447], colour: '#ffaa00' },
            'Hong Kong-Zhuhai-Macao Bridge': { coords: [22.28306, 113.78056], colour: '#ffaa00' },
            'Heung Yuen Wai': { coords: [22.55429, 114.15242], colour: '#ffaa00' },
            'Express Rail Link West Kowloon': { coords: [22.30361, 114.16500], colour: '#ffaa00' },
            'China Ferry Terminal': { coords: [22.29931, 114.16725], colour: '#44ff44' },
            'Macau Ferry Terminal': { coords: [22.28937, 114.15215], colour: '#44ff44' },
            'Kai Tak Cruise Terminal': { coords: [22.3074, 114.2128], colour: '#44ff44' },
            'Hung Hom': { coords: [22.302, 114.179], colour: '#ffaa00' },
            'Tuen Mun Ferry Terminal': { coords: [22.392, 113.978], colour: '#44ff44' },
            'Harbour Control': { coords: [22.290, 114.160], colour: '#44ff44' }
        };

        const map = L.map('map').setView([22.35, 114.1], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            dark: true
        }).addTo(map);

        L.tileLayer('https://cartodb-basemaps-c.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {
            attribution: '© CartoDB'
        }).addTo(map);

        let latestData = {};

        // Load CSV and calculate recent 7-day averages
        Papa.parse('https://dannytcchan00.github.io/0Data/data/immi/immi_daily/data.csv', {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                const df = results.data.reverse(); // Latest first
                const recentDays = 7;
                const recentRecords = df.slice(0, recentDays * 32); // ~32 records per day
                
                recentRecords.forEach(row => {
                    if (!row['Control Point'] || row['Total'] === '' || row['Total'] === '0') return;
                    const point = row['Control Point'];
                    const total = parseInt(row['Total']) || 0;
                    const direction = row['Arrival / Departure'];
                    
                    if (!latestData[point]) {
                        latestData[point] = { arrivals: 0, departures: 0, total: 0, count: 0 };
                    }
                    latestData[point][direction.toLowerCase()] += total;
                    latestData[point].total += total;
                    latestData[point].count += 1;
                });

                Object.keys(latestData).forEach(point => {
                    const data = latestData[point];
                    data.avgArrivals = Math.round(data.arrivals / data.count);
                    data.avgDepartures = Math.round(data.departures / data.count);
                    data.avgTotal = Math.round(data.total / data.count);
                });

                addMarkers();
                document.getElementById('status').innerHTML = 
                    `Loaded ${Object.keys(latestData).length} control points.<br>
                     Showing 7-day averages. <small>Data: Immigration Dept [attached_file:1]</small>`;
            }
        });

        function addMarkers() {
            Object.entries(controlPoints).forEach(([name, info]) => {
                const data = latestData[name];
                if (!data) return;
                
                const popupContent = `
                    <div style="min-width: 250px; font-size: 14px;">
                        <h3 style="margin: 0 0 10px 0; color: ${info.colour};">${name}</h3>
                        <div><strong>Average Daily Arrivals:</strong> ${data.avgArrivals.toLocaleString()}</div>
                        <div><strong>Average Daily Departures:</strong> ${data.avgDepartures.toLocaleString()}</div>
                        <hr style="margin: 10px 0;">
                        <div><strong>Total Daily Average:</strong> ${data.avgTotal.toLocaleString()}</div>
                        <small>(Last ${data.count} records)</small>
                    </div>
                `;
                
                const marker = L.circleMarker(info.coords, {
                    radius: 8,
                    fillColor: info.colour,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 0.9,
                    fillOpacity: 0.7
                }).addTo(map)
                .bindPopup(popupContent, { maxWidth: 300 })
                .bindTooltip(name, { direction: 'top' });
            });
        }
    </script>
</body>
</html>
