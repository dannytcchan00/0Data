<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hong Kong Border Flow - Live Data</title>

  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: radial-gradient(circle at top, #1b2340 0%, #05070b 55%, #020308 100%);
      color: #e5e7eb;
      overflow: hidden;
      height: 100vh;
    }
    #map {
      height: 100vh;
      width: 100%;
      filter: contrast(1.08) saturate(1.15);
    }

    /* left info panel */
    .info-panel {
      position: absolute;
      inset: 0 auto 0 0;
      width: 380px;
      background: rgba(8, 11, 24, 0.96);
      backdrop-filter: blur(26px);
      border-right: 1px solid rgba(148, 163, 184, 0.35);
      padding: 24px 22px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 0 60px rgba(0, 0, 0, 0.65);
    }
    .panel-header {
      padding-bottom: 18px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.35);
      margin-bottom: 18px;
    }
    .panel-title {
      font-size: 22px;
      font-weight: 700;
      color: #fbbf24;
      text-shadow: 0 0 16px rgba(251, 191, 36, 0.5);
    }
    .status-bar {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      background: linear-gradient(135deg, rgba(15,23,42,0.9), rgba(15,23,42,0.7));
      padding: 9px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }
    .status-ok      { color: #22c55e; }
    .status-loading { color: #f97316; animation: pulse 1.4s infinite; }
    @keyframes pulse {
      0%,100% { opacity: 0.55; }
      50%     { opacity: 1; }
    }

    .date-picker {
      margin: 18px 0 10px;
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      font-size: 14px;
      padding: 11px 12px;
      outline: none;
      cursor: pointer;
    }
    .date-picker:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.35);
    }
    .selected-date {
      display: none;
      margin-bottom: 14px;
      padding: 10px 11px;
      border-radius: 9px;
      background: rgba(22, 163, 74, 0.24);
      border: 1px solid rgba(22, 163, 74, 0.8);
      font-size: 13px;
      font-weight: 500;
      color: #bbf7d0;
      text-align: centre;
    }

    .border-card {
      background: rgba(15,23,42,0.97);
      border-radius: 14px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      padding: 14px 13px 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease, background 0.18s ease;
    }
    .border-card:hover {
      transform: translateX(4px);
      border-color: rgba(56, 189, 248, 0.85);
      background: rgba(15,23,42, 0.9);
      box-shadow: 0 10px 26px rgba(15,23,42,0.85);
    }
    .border-card.active {
      border-color: #38bdf8;
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.75);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.18), rgba(15,23,42,0.96));
    }
    .card-header {
      display: flex;
      align-items: centre;
      gap: 9px;
      margin-bottom: 8px;
    }
    .card-dot {
      width: 11px;
      height: 11px;
      border-radius: 999px;
      box-shadow: 0 0 10px rgba(148, 163, 184, 0.7);
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: #e5e7eb;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card-total {
      font-size: 13px;
      font-weight: 600;
      color: #38bdf8;
    }
    .card-rows {
      margin-top: 6px;
      font-size: 12px;
      line-height: 1.25;
    }
    .card-row {
      display: flex;
      justify-content: space-between;
      align-items: centre;
      padding: 3px 0;
    }
    .card-row-label {
      display: flex;
      align-items: centre;
      gap: 4px;
    }
    .card-row-label span.flag {
      font-size: 11px;
    }
    .card-row-label span.text {
      font-weight: 500;
    }
    .card-row-value {
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      font-weight: 600;
    }
    .card-row-value.hk { color: #60a5fa; }
    .card-row-value.cn { color: #f97373; }
    .card-row-value.ot { color: #4ade80; }

    .legend {
      position: absolute;
      right: 18px;
      bottom: 18px;
      background: rgba(15,23,42,0.98);
      border-radius: 13px;
      padding: 11px 13px;
      border: 1px solid rgba(148, 163, 184, 0.65);
      font-size: 11px;
      z-index: 900;
    }
    .legend-item {
      display: flex;
      align-items: centre;
      margin: 3px 0;
    }
    .legend-colour {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      margin-right: 6px;
    }

    /* popup sizing + typography */
    .leaflet-popup-content-wrapper {
      background: radial-gradient(circle at top, #020617 0%, #020617 40%, #020617 100%);
      border-radius: 18px;
      border: 1px solid rgba(56, 189, 248, 0.5);
      box-shadow: 0 18px 40px rgba(0,0,0,0.8);
      max-width: 340px;
    }
    .leaflet-popup-content {
      margin: 0;
      padding: 14px 16px 13px;
      font-family: "Inter", system-ui, sans-serif;
    }

    @media (max-width: 768px) {
      .info-panel {
        width: 100%;
        height: 48vh;
        inset: auto 0 0 0;
        border-right: none;
        border-top: 1px solid rgba(148,163,184,0.45);
      }
      #map {
        height: 52vh;
      }
    }
  </style>
</head>
<body>
<div id="map"></div>

<div class="info-panel">
  <div class="panel-header">
    <h1 class="panel-title">üõÇ Border Flow</h1>
    <div class="status-bar">
      <span id="syncStatus" class="status-loading">Loading GitHub CSV‚Ä¶</span>
      <span id="recordCount">‚Äì</span>
    </div>
  </div>

  <input id="datePicker" class="date-picker"
         type="text"
         placeholder="Select date (dd-mm-yyyy)">
  <div id="selectedDateDisplay" class="selected-date"></div>

  <div id="borderCards"></div>
</div>

<div class="legend">
  <div class="legend-item">
    <div class="legend-colour" style="background:#f97373;"></div> Airport
  </div>
  <div class="legend-item">
    <div class="legend-colour" style="background:#facc15;"></div> Land
  </div>
  <div class="legend-item">
    <div class="legend-colour" style="background:#4ade80;"></div> Sea
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
  const CSV_URL =
    "https://dannytcchan00.github.io/0Data/data/immi/immi_daily/data.csv";

  const controlPoints = {
    "Airport":                        { coords: [22.30889, 113.91444], colour: "#f97373", icon: "üõ©Ô∏è" },
    "Lo Wu":                          { coords: [22.53222, 114.11333], colour: "#facc15", icon: "üåâ" },
    "Lok Ma Chau":                    { coords: [22.52074, 114.07496], colour: "#facc15", icon: "üåâ" },
    "Lok Ma Chau Spur Line":          { coords: [22.51577, 114.06877], colour: "#facc15", icon: "üåâ" },
    "Man Kam To":                     { coords: [22.5370,  114.1294 ], colour: "#facc15", icon: "üåâ" },
    "Sha Tau Kok":                    { coords: [22.54911, 114.22328], colour: "#facc15", icon: "üåâ" },
    "Shenzhen Bay":                   { coords: [22.5039,  113.9447 ], colour: "#facc15", icon: "üåâ" },
    "Hong Kong-Zhuhai-Macao Bridge":  { coords: [22.28306, 113.78056], colour: "#facc15", icon: "üåâ" },
    "Heung Yuen Wai":                 { coords: [22.55429, 114.15242], colour: "#facc15", icon: "üåâ" },
    "Express Rail Link West Kowloon": { coords: [22.30361, 114.16500], colour: "#facc15", icon: "üöÑ" },
    "China Ferry Terminal":           { coords: [22.29931, 114.16725], colour: "#4ade80", icon: "üö¢" },
    "Macau Ferry Terminal":           { coords: [22.28937, 114.15215], colour: "#4ade80", icon: "üö¢" },
    "Kai Tak Cruise Terminal":        { coords: [22.3074,  114.2128 ], colour: "#4ade80", icon: "üö¢" },
    "Hung Hom":                       { coords: [22.302,   114.179  ], colour: "#facc15", icon: "üöÑ" },
    "Tuen Mun Ferry Terminal":        { coords: [22.392,   113.978  ], colour: "#4ade80", icon: "üö¢" },
    "Harbour Control":                { coords: [22.290,   114.160  ], colour: "#4ade80", icon: "üö¢" }
  };

  const map = L.map("map", { zoomControl: true }).setView([22.35, 114.1], 10);
  L.control.zoom({ position: "topright" }).addTo(map);
  L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
    {
      attribution: "¬© OpenStreetMap ¬© CARTO",
      maxZoom: 19
    }
  ).addTo(map);

  let allData = [];
  let currentData = {};
  let markers = {};
  let selectedDate = "";
  let activePoint = null;

  async function syncCSV() {
    const status = document.getElementById("syncStatus");
    status.textContent = "Loading GitHub CSV‚Ä¶";
    status.className = "status-loading";

    try {
      const res = await fetch(CSV_URL, {
        headers: { "Accept": "text/csv" }
      });
      if (!res.ok) throw new Error(res.status);
      let text = await res.text();
      text = text.replace(/^\uFEFF/, "");

      const lines   = text.split("\n").filter(l => l.trim());
      const headers = lines[0].split(",").map(h => h.trim().replace(/^"|"$/g, ""));

      allData = lines.slice(1).map(line => {
        const values = line
          .split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
          .map(v => v.trim().replace(/^"|"$/g, ""));
        const row = {};
        headers.forEach((h, i) => { row[h] = values[i] || ""; });
        return row;
      }).filter(r => r["Control Point"] && r.Date).reverse();

      document.getElementById("recordCount").textContent =
        `${allData.length.toLocaleString("en-GB")} records`;
      status.innerHTML = `CSV loaded <strong>${allData[0]?.Date}</strong>`;
      status.className = "status-ok";

      loadDateData(allData[0]?.Date);
    } catch (e) {
      status.textContent = "CSV load failed";
      status.className   = "status-loading";
      console.error(e);
    }
  }

  function loadDateData(dateStr) {
    selectedDate = dateStr || "";
    const dateEl = document.getElementById("selectedDateDisplay");

    if (!dateStr) {
      dateEl.style.display = "none";
      currentData = {};
      renderBorderCards();
      return;
    }

    const rows = allData.filter(r => r.Date === dateStr);
    if (!rows.length) {
      dateEl.textContent = `No data for ${dateStr}`;
      dateEl.style.display = "block";
      currentData = {};
      renderBorderCards();
      return;
    }

    currentData = {};
    for (const row of rows) {
      const cp = row["Control Point"];
      if (!controlPoints[cp]) continue;

      if (!currentData[cp]) {
        currentData[cp] = {
          hk:    { arrivals: 0, departures: 0 },
          cn:    { arrivals: 0, departures: 0 },
          other: { arrivals: 0, departures: 0 }
        };
      }
      const nums = {
        hk:    parseInt(row["Hong Kong Residents"]) || 0,
        cn:    parseInt(row["Mainland Visitors"])   || 0,
        other: parseInt(row["Other Visitors"])      || 0
      };
      const dir = row["Arrival / Departure"]?.includes("Arrival")
        ? "arrivals"
        : "departures";
      for (const k of ["hk","cn","other"]) {
        currentData[cp][k][dir] += nums[k];
      }
    }

    dateEl.textContent = dateStr;
    dateEl.style.display = "block";
    renderBorderCards();
  }

  function renderBorderCards() {
    const wrap = document.getElementById("borderCards");
    wrap.innerHTML = "";

    Object.entries(controlPoints).forEach(([name, meta]) => {
      const d = currentData[name] || {
        hk: {arrivals:0,departures:0},
        cn: {arrivals:0,departures:0},
        other:{arrivals:0,departures:0}
      };
      const total =
        d.hk.arrivals + d.hk.departures +
        d.cn.arrivals + d.cn.departures +
        d.other.arrivals + d.other.departures;

      const card = document.createElement("div");
      card.className = "border-card" + (activePoint === name ? " active" : "");
      card.onclick = () => showPoint(name);

      card.innerHTML = `
        <div class="card-header">
          <div class="card-dot" style="background:${meta.colour};"></div>
          <div class="card-title">${meta.icon} ${name}</div>
          <div class="card-total">${total.toLocaleString("en-GB")}</div>
        </div>
        <div class="card-rows">
          <div class="card-row">
            <div class="card-row-label">
              <span class="flag">üá≠üá∞</span>
              <span class="text">HK Residents</span>
            </div>
            <div class="card-row-value hk">
              ${(d.hk.arrivals + d.hk.departures).toLocaleString("en-GB")}
            </div>
          </div>
          <div class="card-row">
            <div class="card-row-label">
              <span class="flag">üá®üá≥</span>
              <span class="text">China Visitors</span>
            </div>
            <div class="card-row-value cn">
              ${(d.cn.arrivals + d.cn.departures).toLocaleString("en-GB")}
            </div>
          </div>
          <div class="card-row">
            <div class="card-row-label">
              <span class="flag">üåç</span>
              <span class="text">Other Visitors</span>
            </div>
            <div class="card-row-value ot">
              ${(d.other.arrivals + d.other.departures).toLocaleString("en-GB")}
            </div>
          </div>
        </div>
      `;
      wrap.appendChild(card);
    });
  }

  function showPoint(name) {
    // clear existing marker
    Object.values(markers).forEach(m => map.removeLayer(m));
    markers = {};

    activePoint = name;
    document
      .querySelectorAll(".border-card")
      .forEach(c => c.classList.remove("active"));
    const cards = Array.from(document.querySelectorAll(".border-card"));
    const match = cards.find(c =>
      c.querySelector(".card-title")?.textContent.includes(name)
    );
    if (match) match.classList.add("active");

    const meta = controlPoints[name];
    if (!meta) return;

    const d = currentData[name] || {
      hk:{arrivals:0,departures:0},
      cn:{arrivals:0,departures:0},
      other:{arrivals:0,departures:0}
    };
    const total =
      d.hk.arrivals + d.hk.departures +
      d.cn.arrivals + d.cn.departures +
      d.other.arrivals + d.other.departures;

    markers[name] = L.circleMarker(meta.coords, {
      radius: 14,
      fillColor: meta.colour,
      color: "#ffffff",
      weight: 4,
      opacity: 1,
      fillOpacity: 0.9
    }).addTo(map);

    const popup = `
      <div style="font-size:13px; line-height:1.35;">
        <div style="display:flex; align-items:center; justify-content:center;
                    gap:6px; margin-bottom:8px;">
          <span style="font-size:18px;">${meta.icon}</span>
          <span style="font-size:18px; font-weight:700; color:#fbbf24;">
            ${name}
          </span>
        </div>

        <div style="background:#14532d; border-radius:9px;
                    padding:7px 10px; margin-bottom:10px;
                    display:flex; align-items:center; justify-content:center;
                    font-size:12px; font-weight:600; color:#bbf7d0;">
          <span style="margin-right:6px;">üìÖ</span>
          <span>${selectedDate || "Latest date"}</span>
        </div>

        <!-- 3 aligned rows -->
        <div style="border-radius:10px; background:#020617;
                    border:1px solid rgba(51,65,85,0.9); padding:8px 9px;">
          <div style="display:flex; justify-content:space-between; align-items:center;
                      padding:3px 0;">
            <div style="display:flex; align-items:center; gap:5px;">
              <span>üá≠üá∞</span>
              <span style="color:#60a5fa; font-weight:600;">HK Residents</span>
            </div>
            <div style="font-variant-numeric:tabular-nums; white-space:nowrap;
                        color:#60a5fa; font-weight:600;">
              ${d.hk.arrivals.toLocaleString("en-GB")}‚Üó
              ${d.hk.departures.toLocaleString("en-GB")}‚Üò
            </div>
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center;
                      padding:3px 0;">
            <div style="display:flex; align-items:center; gap:5px;">
              <span>üá®üá≥</span>
              <span style="color:#fb7185; font-weight:600;">China Visitors</span>
            </div>
            <div style="font-variant-numeric:tabular-nums; white-space:nowrap;
                        color:#fb7185; font-weight:600;">
              ${d.cn.arrivals.toLocaleString("en-GB")}‚Üó
              ${d.cn.departures.toLocaleString("en-GB")}‚Üò
            </div>
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center;
                      padding:3px 0;">
            <div style="display:flex; align-items:center; gap:5px;">
              <span>üåç</span>
              <span style="color:#4ade80; font-weight:600;">Other Visitors</span>
            </div>
            <div style="font-variant-numeric:tabular-nums; white-space:nowrap;
                        color:#4ade80; font-weight:600;">
              ${d.other.arrivals.toLocaleString("en-GB")}‚Üó
              ${d.other.departures.toLocaleString("en-GB")}‚Üò
            </div>
          </div>
        </div>

        <div style="margin-top:10px; padding:9px 10px;
                    border-radius:11px; background:#020617;
                    border:1px solid rgba(56,189,248,0.7); text-align:center;">
          <div style="font-size:12px; color:#38bdf8; font-weight:600;">
            Total Flow
          </div>
          <div style="font-size:20px; font-weight:700; color:#38bdf8;
                      font-variant-numeric:tabular-nums;">
            ${total.toLocaleString("en-GB")}
          </div>
        </div>

        <div style="margin-top:9px; padding-top:7px;
                    border-top:1px solid rgba(51,65,85,0.9);
                    font-size:11px; color:#9ca3af; text-align:center;">
          ‚úî GitHub CSV data ‚Ä¢
          ${new Date().toLocaleString("en-GB", { hour12: false })}
        </div>
      </div>
    `;

    markers[name].bindPopup(popup, { maxWidth: 340 }).openPopup();
    map.setView(meta.coords, 13, { animate: true });
  }

  // init
  (function init() {
    syncCSV();
    flatpickr("#datePicker", {
      dateFormat: "d-m-Y",
      altInput: false,
      maxDate: "today",
      onChange(selected) {
        if (selected[0]) {
          const d = selected[0];
          const iso = d.toISOString().slice(0,10).split("-").reverse().join("-");
          loadDateData(iso);
        }
      }
    });
    // auto-refresh every 5 mins
    setInterval(syncCSV, 5 * 60 * 1000);
  })();
</script>
</body>
</html>
