<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hong Kong Border Flow - Live Data</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #e8e8e8; overflow: hidden;
        }
        #map { height: 100vh; width: 100%; filter: contrast(1.1) saturate(1.2); }
        
        .panel {
            position: absolute; background: rgba(15,15,25,0.95);
            backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; box-shadow: 0 25px 45px rgba(0,0,0,0.4);
        }
        
        .top-left { top: 25px; left: 25px; width: 500px; padding: 25px; z-index: 1000; }
        .top-left h2 { margin: 0 0 18px 0; color: #4fc3f7; font-size: 24px; font-weight: 700; }
        .status-bar { background: rgba(30,30,40,0.8); border-radius: 12px; padding: 12px; margin: 15px 0; font-size: 14px; }
        .status-ok { color: #10b981; }
        .status-error { color: #ef4444; }
        .status-loading { color: #f59e0b; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:.6} 50%{opacity:1} }
        .date-picker { background: rgba(30,30,40,0.8); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px 16px; margin: 15px 0; color: #e8e8e8; font-size: 15px; width: 100%; cursor: pointer; }
        .date-picker:focus { border-color: #4fc3f7; box-shadow: 0 0 0 3px rgba(79,195,247,0.2); }
        .selected-date { background: rgba(16,185,129,0.3); border-color: #10b981; margin: 10px 0; padding: 12px; border-radius: 10px; font-weight: 500; }
        
        /* âœ… å£å²¸åˆ—è¡¨æ•´é½ŠåŒ– */
        .border-list { margin: 0; padding: 0; list-style: none; max-height: 60vh; overflow-y: auto; }
        .border-list-item { 
            display: flex; align-items: flex-start; padding: 14px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.04); 
            gap: 12px; /* å£å²¸åèˆ‡æ•¸æ“šé–“è· */
        }
        .border-list-item:last-child { border-bottom: none; }
        
        /* âœ… å£å²¸åç¨±ç¸®ç´° + é å·¦ */
        .border-name { 
            flex: 0 0 160px; /* å›ºå®šå¯¬åº¦ï¼Œé•·åç¨±è‡ªå‹•æ›è¡Œ */
            font-size: 14px; /* ç¸®ç´°å­—å‹ */
            font-weight: 600; 
            color: #10b981; 
            cursor: pointer; 
            line-height: 1.3; 
            padding: 4px 8px; 
            border-radius: 6px; 
            transition: all 0.2s;
            white-space: normal; /* å…è¨±æ›è¡Œ */
            height: 36px; /* å›ºå®šé«˜åº¦ */
            display: flex; align-items: center;
            text-decoration: none;
        }
        .border-name:hover { 
            background: rgba(16,185,129,0.2); 
            color: #4fc3f7; 
            transform: translateX(4px);
        }
        
        .arrdep-cnt { 
            display: flex; gap: 8px; flex: 1; /* ä½”æ»¿å‰©é¤˜ç©ºé–“ */
            flex-wrap: wrap; 
        }
        .cnt-group { 
            text-align: right; min-width: 70px; 
            flex: 1; /* å¹³å‡åˆ†é…ç©ºé–“ */
        }
        .cnt-label { 
            font-size: 10px; color: #a1a1aa; display: block; 
            line-height: 1.1; margin-bottom: 2px;
        }
        .cnt-number { 
            font-size: 13px; font-weight: 700; 
            line-height: 1.1; min-height: 18px;
        }
        .cnt-hk { color: #3b82f6; }
        .cnt-cn { color: #ef4444; }
        .cnt-other { color: #10b981; }
        
        .legend { bottom: 25px; right: 25px; padding: 20px; width: 240px; font-size: 14px; }
        .legend-item { display: flex; align-items: center; margin: 12px 0; font-weight: 500; }
        .legend-color { width: 16px; height: 16px; margin-right: 12px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        
        .leaflet-popup-content-wrapper { 
            background: rgba(15,15,25,0.98); border-radius: 20px; border: 1px solid rgba(255,255,255,0.15);
            backdrop-filter: blur(25px); max-width: 420px; margin: 10px; max-height: 480px; overflow-y: auto;
        }
        .leaflet-popup-content { margin: 0; padding: 25px; color: #e8e8e8; font-family: 'Inter', sans-serif; line-height: 1.5; }
        .popup-title { color: #4fc3f7; font-size: 22px; font-weight: 700; margin: 0 0 20px 0; }
        .data-section { margin: 16px 0; padding: 18px; background: rgba(40,40,60,0.7); border-radius: 14px; border: 1px solid rgba(255,255,255,0.08); }
        .data-title { font-size: 15px; font-weight: 600; margin-bottom: 12px; color: #e8e8e8; }
        .data-title.selected { color: #10b981; background: rgba(16,185,129,0.2); padding: 8px 12px; border-radius: 8px; display: inline-block; }
        .category-row { display: flex; justify-content: space-between; align-items: center; margin: 8px 0; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .category-row:last-child { border-bottom: none; }
        .category-label { font-weight: 500; }
        .hk-label { color: #3b82f6; } .cn-label { color: #ef4444; } .other-label { color: #10b981; }
        .category-number { font-size: 18px; font-weight: 700; }
        .hk-num { color: #3b82f6; } .cn-num { color: #ef4444; } .other-num { color: #10b981; }
        .total-row { margin-top: 12px; padding-top: 12px; border-top: 2px solid rgba(79,195,247,0.3); }
        .total-label { font-weight: 600; color: #4fc3f7; }
        .total-number { font-size: 20px; color: #4fc3f7; }
        .date-note { font-size: 13px; color: #a1a1aa; margin-top: 15px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="panel top-left">
        <h2>ğŸ›‚ Border Control Points Flow</h2>
        <div class="status-bar" id="statusBar">
            <span id="syncStatus" class="status-loading">ğŸ”„ Loading GitHub CSV...</span>
            <span id="recordCount">-</span>
        </div>
        <input type="text" class="date-picker" id="datePicker" placeholder="Select date (dd-mm-yyyy)">
        <div id="selectedDateDisplay" class="selected-date" style="display:none;">ğŸ“… Latest data</div>
        <ul class="border-list" id="borderList"></ul>
    </div>
    <div class="panel legend">
        <div class="legend-item"><div class="legend-color" style="background:#ff4444;"></div>ğŸ›©ï¸ Airport</div>
        <div class="legend-item"><div class="legend-color" style="background:#ffaa00;"></div>ğŸŒ‰ Land</div>
        <div class="legend-item"><div class="legend-color" style="background:#44ff44;"></div>ğŸš¢ Ferry</div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        const CSV_URL = 'https://dannytcchan00.github.io/0Data/data/immi/immi_daily/data.csv';
        const controlPoints = {
            'Airport': { coords: [22.30889, 113.91444], colour: '#ff4444' },
            'Lo Wu': { coords: [22.53222, 114.11333], colour: '#ffaa00' },
            'Lok Ma Chau': { coords: [22.52074, 114.07496], colour: '#ffaa00' },
            'Lok Ma Chau Spur Line': { coords: [22.51577, 114.06877], colour: '#ffaa00' },
            'Man Kam To': { coords: [22.5370, 114.1294], colour: '#ffaa00' },
            'Sha Tau Kok': { coords: [22.54911, 114.22328], colour: '#ffaa00' },
            'Shenzhen Bay': { coords: [22.5039, 113.9447], colour: '#ffaa00' },
            'Hong Kong-Zhuhai-Macao Bridge': { coords: [22.28306, 113.78056], colour: '#ffaa00' },
            'Heung Yuen Wai': { coords: [22.55429, 114.15242], colour: '#ffaa00' },
            'Express Rail Link West Kowloon': { coords: [22.30361, 114.16500], colour: '#ffaa00' },
            'China Ferry Terminal': { coords: [22.29931, 114.16725], colour: '#44ff44' },
            'Macau Ferry Terminal': { coords: [22.28937, 114.15215], colour: '#44ff44' },
            'Kai Tak Cruise Terminal': { coords: [22.3074, 114.2128], colour: '#44ff44' },
            'Hung Hom': { coords: [22.302, 114.179], colour: '#ffaa00' },
            'Tuen Mun Ferry Terminal': { coords: [22.392, 113.978], colour: '#44ff44' },
            'Harbour Control': { coords: [22.290, 114.160], colour: '#44ff44' }
        };
        
        const map = L.map('map', { zoomControl: true }).setView([22.35, 114.1], 10);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.tileLayer('https://cartodb-basemaps-c.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap Â© CartoDB', maxZoom: 19
        }).addTo(map);
        
        let allData = [], currentData = {}, markers = {}, selectedDate = '';

        async function syncCSV() {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = 'ğŸ”„ Loading GitHub CSV...';
            statusEl.className = 'status-loading';
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                const response = await fetch(CSV_URL, { signal: controller.signal, headers: { 'Accept': 'text/csv' } });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                let text = await response.text();
                text = text.replace(/^\uFEFF/, '');
                const lines = text.split('\n').filter(line => line.trim());
                const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                allData = lines.slice(1).map(line => {
                    const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/^"|"$/g, ''));
                    const row = {};
                    headers.forEach((header, i) => { row[header] = values[i] || ''; });
                    return row;
                }).filter(row => row['Control Point'] && row.Date && row.Date !== '').reverse();
                if (allData.length === 0) throw new Error('No valid data found');
                document.getElementById('recordCount').textContent = `${allData.length.toLocaleString()} records`;
                statusEl.innerHTML = `âœ… GitHub CSV loaded <strong>${allData[0]?.Date}</strong>`;
                statusEl.className = 'status-ok';
                loadDateData(allData[0]?.Date || '');
            } catch (error) {
                statusEl.textContent = `âŒ GitHub CSV failed: ${error.message.slice(0,40)}`;
                statusEl.className = 'status-error';
            }
        }

        function loadDateData(dateStr) {
            selectedDate = dateStr;
            const dateDisplay = document.getElementById('selectedDateDisplay');
            if (!dateStr) {
                dateDisplay.style.display = 'none';
                processLatestData();
                return;
            }
            const dateData = allData.filter(row => row.Date === dateStr);
            if (dateData.length === 0) {
                dateDisplay.textContent = `ğŸ“… No data for ${dateStr}`;
                dateDisplay.style.display = 'block';
                return;
            }
            currentData = {};
            dateData.forEach(row => {
                const point = row['Control Point'];
                if (!point || !controlPoints[point]) return;
                if (!currentData[point]) {
                    currentData[point] = { hk: {arrivals: 0, departures: 0}, cn: {arrivals: 0, departures: 0}, other: {arrivals: 0, departures: 0} };
                }
                const nums = { hk: parseInt(row['Hong Kong Residents']) || 0, cn: parseInt(row['Mainland Visitors']) || 0, other: parseInt(row['Other Visitors']) || 0 };
                const dir = row['Arrival / Departure']?.toLowerCase().includes('arrival') ? 'arrivals' : 'departures';
                Object.keys(nums).forEach(cat => { currentData[point][cat][dir] += nums[cat]; });
            });
            dateDisplay.textContent = `ğŸ“… ${dateStr} (${dateData.length} records)`;
            dateDisplay.style.display = 'block';
            updateBorderList();
        }

        function processLatestData() {
            updateBorderList();
        }

        function updateBorderList() {
            const listEl = document.getElementById('borderList');
            listEl.innerHTML = '';
            Object.entries(controlPoints).forEach(([cp, cfg]) => {
                const d = currentData[cp] || {hk:{arrivals:0,departures:0},cn:{arrivals:0,departures:0},other:{arrivals:0,departures:0}};
                const li = document.createElement('li');
                li.className = 'border-list-item';
                
                // âœ… å£å²¸åç¨±å€åŸŸ
                const nameDiv = document.createElement('div');
                nameDiv.className = 'border-name';
                nameDiv.textContent = cp;
                nameDiv.onclick = () => showSingleMarker(cp);
                li.appendChild(nameDiv);

                // âœ… æ•¸æ“šå€åŸŸ
                const arrdep = document.createElement('div');
                arrdep.className = 'arrdep-cnt';
                ['hk','cn','other'].forEach(cat => {
                    const grp = document.createElement('div');
                    grp.className = 'cnt-group cnt-' + cat;
                    const label = cat === 'hk' ? 'HK' : (cat === 'cn' ? 'China' : 'Other');
                    grp.innerHTML = `
                        <span class='cnt-label'>${label} Arr</span>
                        <div class='cnt-number cnt-${cat}'>${d[cat].arrivals.toLocaleString()}</div>
                        <span class='cnt-label'>Dep</span>
                        <div class='cnt-number cnt-${cat}'>${d[cat].departures.toLocaleString()}</div>
                    `;
                    arrdep.appendChild(grp);
                });
                li.appendChild(arrdep);
                listEl.appendChild(li);
            });
        }

        function showSingleMarker(cp) {
            Object.keys(markers).forEach(n => {
                map.removeLayer(markers[n]);
                delete markers[n];
            });
            const coords = controlPoints[cp].coords;
            const color = controlPoints[cp].colour;
            const d = currentData[cp] || {hk:{arrivals:0,departures:0},cn:{arrivals:0,departures:0},other:{arrivals:0,departures:0}};
            const popupContent = `
                <div>
                    <h3 class="popup-title" style="color:${color};">${cp}</h3>
                    <div class="data-section">
                        <div class="data-title selected">${selectedDate ? `ğŸ“… ${selectedDate}` : 'ğŸ“… Latest Data'}</div>
                        <div class="category-row">
                            <span class="category-label hk-label">ğŸ‡­ğŸ‡° HK Residents</span>
                            <span class="category-number hk-num">${d.hk.arrivals.toLocaleString()}â†— ${d.hk.departures.toLocaleString()}â†˜</span>
                        </div>
                        <div class="category-row">
                            <span class="category-label cn-label">ğŸ‡¨ğŸ‡³ China Visitors</span>
                            <span class="category-number cn-num">${d.cn.arrivals.toLocaleString()}â†— ${d.cn.departures.toLocaleString()}â†˜</span>
                        </div>
                        <div class="category-row">
                            <span class="category-label other-label">ğŸŒ Other Visitors</span>
                            <span class="category-number other-num">${d.other.arrivals.toLocaleString()}â†— ${d.other.departures.toLocaleString()}â†˜</span>
                        </div>
                        <div class="category-row total-row">
                            <span class="total-label">ğŸ’ Total</span>
                            <span class="total-number">${(d.hk.arrivals + d.hk.departures + d.cn.arrivals + d.cn.departures + d.other.arrivals + d.other.departures).toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="date-note">âœ… GitHub CSV data</div>
                </div>
            `;
            markers[cp] = L.circleMarker(coords, {
                radius: 14, fillColor: color, color: '#ffffff', weight: 3, opacity: 1, fillOpacity: 0.85
            }).addTo(map).bindPopup(popupContent, { maxWidth: 420, className: 'custom-popup' }).openPopup();
            map.setView(coords, 13, {animate: true});
        }

        window.addEventListener('load', async () => {
            await syncCSV();
            flatpickr("#datePicker", {
                dateFormat: "d-m-Y", altInput: true, altFormat: "d MMM YYYY",
                maxDate: "today", locale: "en",
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates[0]) {
                        const formattedDate = selectedDates[0].toISOString().split('T')[0].split('-').reverse().join('-');
                        loadDateData(formattedDate);
                    } else {
                        loadDateData('');
                    }
                }
            });
        });
        setInterval(syncCSV, 5 * 60 * 1000);
    </script>
</body>
</html>
