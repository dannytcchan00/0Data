<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hong Kong A&E Waiting Times</title>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, 'SF Pro Display', sans-serif; 
            background: linear-gradient(135deg, #0f1419 0%, #1a1f26 100%);
            color: #e8eaed; min-height: 100vh; overflow: hidden;
        }
        .container { display: flex; height: 100vh; }
        .sidebar { 
            width: 380px; background: rgba(20,25,30,0.95); 
            backdrop-filter: blur(20px); border-right: 1px solid #2a3440;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .header { 
            padding: 20px; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            text-align: center; 
        }
        .header h1 { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
        .last-update { font-size: 12px; opacity: 0.9; }
        .tabs { display: flex; background: rgba(40,50,60,0.8); }
        .tab { flex: 1; padding: 15px 10px; text-align: center; cursor: pointer; 
               font-size: 14px; border-bottom: 2px solid transparent; 
               transition: all 0.2s; }
        .tab.active { background: rgba(30,58,138,0.8); border-bottom-color: #3b82f6; color: #fff; }
        .hospital-list { flex: 1; overflow-y: auto; padding: 20px; }
        .hospital-item { 
            display: flex; align-items: center; padding: 16px; 
            margin-bottom: 12px; background: rgba(35,45,55,0.6); 
            border-radius: 12px; cursor: pointer; transition: all 0.2s;
            border: 1px solid transparent;
        }
        .hospital-item:hover, .hospital-item.active { 
            background: rgba(59,130,246,0.2); border-color: #3b82f6; 
            box-shadow: 0 4px 20px rgba(59,130,246,0.3);
        }
        .hospital-info { flex: 1; }
        .hospital-name { 
            font-size: 16px; font-weight: 600; margin-bottom: 4px; 
            display: flex; align-items: center; gap: 8px;
        }
        .status-dot { 
            width: 10px; height: 10px; border-radius: 50%; 
            border: 2px solid rgba(255,255,255,0.35); flex-shrink: 0;
        }
        .status-dot.red { background: #ef4444; box-shadow: 0 0 8px rgba(239,68,68,0.7); }
        .status-dot.yellow { background: #facc15; box-shadow: 0 0 8px rgba(250,204,21,0.7); }
        .status-dot.green { background: #22c55e; box-shadow: 0 0 8px rgba(34,197,94,0.7); }
        .status-dot.grey { background: #6b7280; box-shadow: 0 0 4px rgba(107,114,128,0.6); }
        .waiting-row { display: flex; align-items: center; margin-bottom: 2px; font-size: 13px; }
        .waiting-label { min-width: 90px; font-weight: 500; }
        .waiting-time { font-weight: 700; margin-left: 8px; }
        .urgent { color: #f59e0b; }
        .semi-urgent { color: #10b981; }
        .map-container { flex: 1; position: relative; }
        .leaflet-container { height: 100%; }
        .info-card { 
            position: absolute; top: 20px; right: 20px; width: 340px; 
            background: rgba(15,20,25,0.98); backdrop-filter: blur(20px);
            border-radius: 16px; padding: 24px; border: 1px solid #2a3440;
            box-shadow: 0 25px 50px rgba(0,0,0,0.6); max-height: 65vh; overflow-y: auto;
            display: none; z-index: 1000;
        }
        .info-card.active { display: block; animation: slideIn 0.3s; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } }
        .info-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: #3b82f6; }
        .info-detail { display: flex; justify-content: space-between; margin-bottom: 14px; font-size: 14px; }
        .info-label { opacity: 0.85; font-weight: 500; }
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .sidebar { width: 100%; height: 50vh; }
            .map-container { height: 50vh; }
            .info-card { position: fixed; bottom: 20px; left: 20px; right: 20px; top: auto; width: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="header">
                <h1>üè• A&E Waiting Times</h1>
                <div class="last-update" id="lastUpdate">Last updated: Loading...</div>
            </div>
            <div class="tabs">
                <div class="tab active" data-cluster="all">All</div>
                <div class="tab" data-cluster="hk">Hong Kong Island</div>
                <div class="tab" data-cluster="kowloon">Kowloon</div>
                <div class="tab" data-cluster="nt">New Territories</div>
            </div>
            <div class="hospital-list" id="hospitalList"></div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="info-card" id="infoCard">
                <div class="info-title" id="infoTitle"></div>
                <div class="info-detail">
                    <span class="info-label">Address:</span>
                    <span id="infoAddress"></span>
                </div>
                <div class="info-detail">
                    <span class="info-label">Telephone:</span>
                    <span id="infoPhone"></span>
                </div>
                <div class="info-detail">
                    <span class="info-label">Urgent (T3):</span>
                    <span id="infoUrgent" class="urgent"></span>
                </div>
                <div class="info-detail">
                    <span class="info-label">Semi-urgent (T4/5):</span>
                    <span id="infoSemiUrgent" class="semi-urgent"></span>
                </div>
                <div class="info-detail">
                    <span class="info-label">HA Update:</span>
                    <span id="infoUpdateTime"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ Áî®‰Ω†Êèê‰æõÂòÖË∂ÖÁ≤æÊ∫ñGPSÂ∫ßÊ®ôÔºàÂ∫¶ÂàÜÁßí‚ÜíÂçÅÈÄ≤‰ΩçËΩâÊèõÔºâ
        const hospitals = [
            // Hong Kong Island
            { id: 'PYNEH', name_tc: 'Êù±ÂçÄÂ∞§Âæ∑Â§´‰∫∫ÈÇ£ÊâìÁ¥†ÈÜ´Èô¢', name_en: 'Pamela Youde Nethersole Eastern Hospital', cluster: 'hk', lat: 22.269444, lng: 114.236389, addr: '3 Lo Man Street, Chai Wan', phone: '2595 6111' },
            { id: 'QMH', name_tc: 'Áë™È∫óÈÜ´Èô¢', name_en: 'Queen Mary Hospital', cluster: 'hk', lat: 22.270000, lng: 114.131111, addr: '102 Pok Fu Lam Road', phone: '2255 3838' },
            { id: 'RH', name_tc: 'ÂæãÊï¶Ê≤ªÈÜ´Èô¢', name_en: 'Ruttonjee Hospital', cluster: 'hk', lat: 22.276111, lng: 114.175278, addr: '266 Queen\'s Road East, Wan Chai', phone: '2291 2000' },
            { id: 'UCH', name_tc: 'Âü∫Áù£ÊïôËÅØÂêàÈÜ´Èô¢', name_en: 'United Christian Hospital', cluster: 'hk', lat: 22.323056, lng: 114.226944, addr: '130 Hip Wo Street, Kwun Tong', phone: '3949 4000' },
            
            // Kowloon  
            { id: 'CMC', name_tc: 'ÊòéÊÑõÈÜ´Èô¢', name_en: 'Caritas Medical Centre', cluster: 'kowloon', lat: 22.341111, lng: 114.152778, addr: '111 Wing Chun Street, Sham Shui Po', phone: '3408 7911' },
            { id: 'KWH', name_tc: 'Âª£ËèØÈÜ´Èô¢', name_en: 'Kwong Wah Hospital', cluster: 'kowloon', lat: 22.315000, lng: 114.172222, addr: '25 Waterloo Road', phone: '2332 2311' },
            { id: 'PMH', name_tc: 'Áë™ÂòâÁÉàÈÜ´Èô¢', name_en: 'Princess Margaret Hospital', cluster: 'kowloon', lat: 22.340160, lng: 114.134670, addr: '2-10 Princess Margaret Hospital Road, Lai Chi Kok', phone: '2990 1111' },
            { id: 'QEH', name_tc: '‰ºäÂà©Ê≤ô‰ºØÈÜ´Èô¢', name_en: 'Queen Elizabeth Hospital', cluster: 'kowloon', lat: 22.309444, lng: 114.175556, addr: '30 Gascoigne Road', phone: '3506 8888' },
            
            // New Territories
            { id: 'AHNH', name_tc: 'ÈõÖÈ∫óÊ∞è‰ΩïÂ¶ôÈΩ°ÈÇ£ÊâìÁ¥†ÈÜ´Èô¢', name_en: 'Alice Ho Miu Ling Nethersole Hospital', cluster: 'nt', lat: 22.459370, lng: 114.174210, addr: '11 Chuen On Road, Tai Po', phone: '2689 2000' },
            { id: 'NDH', name_tc: 'ÂåóÂçÄÈÜ´Èô¢', name_en: 'North District Hospital', cluster: 'nt', lat: 22.496944, lng: 114.124444, addr: '9 Worthen Road, Sheung Shui', phone: '2683 8888' },
            { id: 'NLTH', name_tc: 'ÂåóÂ§ßÂ∂ºÂ±±ÈÜ´Èô¢', name_en: 'North Lantau Hospital', cluster: 'nt', lat: 22.282500, lng: 113.939167, addr: '8 Chung Yan Road, Tung Chung', phone: '3467 7000' },
            { id: 'POH', name_tc: 'ÂçöÊÑõÈÜ´Èô¢', name_en: 'Pok Oi Hospital', cluster: 'nt', lat: 22.441944, lng: 114.041389, addr: '21 Tsing Lun Road, Tuen Mun', phone: '2486 8000' },
            { id: 'PWH', name_tc: 'Â®ÅÁàæÊñØË¶™ÁéãÈÜ´Èô¢', name_en: 'Prince of Wales Hospital', cluster: 'nt', lat: 22.379700, lng: 114.201700, addr: '30-32 Ngan Shing Street, Shatin', phone: '3505 2211' },
            { id: 'SJH', name_tc: 'Èï∑Ê¥≤ÈÜ´Èô¢', name_en: 'St John Hospital', cluster: 'nt', lat: 22.208056, lng: 114.031389, addr: 'St John\'s Road, Cheung Chau', phone: '2986 2100' },
            { id: 'TSWH', name_tc: 'Â§©Ê∞¥ÂúçÈÜ´Èô¢', name_en: 'Tin Shui Wai Hospital', cluster: 'nt', lat: 22.458611, lng: 113.995556, addr: '11 Tin Tan Street, Tin Shui Wai', phone: '3513 5000' },
            { id: 'TKOH', name_tc: 'Â∞áËªçÊæ≥ÈÜ´Èô¢', name_en: 'Tseung Kwan O Hospital', cluster: 'nt', lat: 22.318056, lng: 114.270278, addr: '2 Po Ning Road, Hang Hau', phone: '2208 0111' },
            { id: 'TMH', name_tc: 'Â±ØÈñÄÈÜ´Èô¢', name_en: 'Tuen Mun Hospital', cluster: 'nt', lat: 22.407680, lng: 113.976000, addr: '23 Tsing Chung Koon Road, Tuen Mun', phone: '2468 5111' },
            { id: 'YCH', name_tc: '‰ªÅÊøüÈÜ´Èô¢', name_en: 'Yan Chai Hospital', cluster: 'nt', lat: 22.369700, lng: 114.119700, addr: '7-11 Yan Chai Street, Tsuen Wan', phone: '2417 8383' }
        ];

        const hospitalMapping = {
            'Alice Ho Miu Ling Nethersole Hospital': 'AHNH',
            'Caritas Medical Centre': 'CMC',
            'Kwong Wah Hospital': 'KWH',
            'North District Hospital': 'NDH',
            'North Lantau Hospital': 'NLTH',
            'Pamela Youde Nethersole Eastern Hospital': 'PYNEH',
            'Pok Oi Hospital': 'POH',
            'Prince of Wales Hospital': 'PWH',
            'Princess Margaret Hospital': 'PMH',
            'Queen Elizabeth Hospital': 'QEH',
            'Queen Mary Hospital': 'QMH',
            'Ruttonjee Hospital': 'RH',
            'St John Hospital': 'SJH',
            'Tin Shui Wai Hospital': 'TSWH',
            'Tseung Kwan O Hospital': 'TKOH',
            'Tuen Mun Hospital': 'TMH',
            'United Christian Hospital': 'UCH',
            'Yan Chai Hospital': 'YCH'
        };

        let map, markers = {}, currentData = {}, selectedHospital = null, currentCluster = 'all';

        function getBusyStatus(urgentTime, semiUrgentTime) {
            if (!urgentTime || !semiUrgentTime) return 'grey';
            const semi95 = semiUrgentTime.split('/')[1].trim();
            const minutes = parseTime(semi95);
            if (minutes >= 360) return 'red';     // ‚â•6Â∞èÊôÇ
            if (minutes >= 180) return 'yellow';  // 3-6Â∞èÊôÇ
            return 'green';                       // <3Â∞èÊôÇ
        }

        function parseTime(timeStr) {
            const num = parseFloat(timeStr);
            if (timeStr.includes('hour')) return num * 60;
            if (timeStr.includes('minute')) return num;
            return 0;
        }

        function parseHAData(rawData) {
            const haUpdateTime = rawData.updateTime;
            rawData.waitTime.forEach(item => {
                const hospitalId = hospitalMapping[item.hospName];
                if (hospitalId && hospitals.find(h => h.id === hospitalId)) {
                    currentData[hospitalId] = {
                        urgent: `${item.t3p50} / ${item.t3p95}`,
                        semiUrgent: `${item.t45p50} / ${item.t45p95}`,
                        updated: haUpdateTime,
                        raw: item,
                        status: getBusyStatus(
                            `${item.t3p50} / ${item.t3p95}`, 
                            `${item.t45p50} / ${item.t45p95}`
                        )
                    };
                }
            });
        }

        async function loadRealHAData() {
            try {
                const response = await fetch('https://www.ha.org.hk/opendata/aed/aedwtdata2-en.json');
                const data = await response.json();
                parseHAData(data);
                document.getElementById('lastUpdate').textContent = `HA Official Update: ${data.updateTime}`;
                renderHospitalList(currentCluster);
                if (selectedHospital) updateInfoCard(selectedHospital);
            } catch (error) {
                console.error('HA API error:', error);
                document.getElementById('lastUpdate').textContent = 'API load failed, retrying in 5 seconds';
                setTimeout(loadRealHAData, 5000);
            }
        }

        function init() {
            initMap();
            initMarkers();
            loadRealHAData();
            setInterval(loadRealHAData, 900000);
            setupEventListeners();
            renderHospitalList('all');
        }

        function initMap() {
            map = L.map('map').setView([22.32, 114.17], 11);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO'
            }).addTo(map);
        }

        function initMarkers() {
            hospitals.forEach(hospital => {
                const marker = L.marker([hospital.lat, hospital.lng], {
                    icon: L.divIcon({
                        className: 'hospital-marker',
                        html: 'üè•',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    })
                }).addTo(map);
                marker.on('click', () => {
                    selectHospital(hospital.id);
                    map.flyTo([hospital.lat, hospital.lng], 15, { duration: 1 });
                });
                markers[hospital.id] = marker;
            });
        }

        function renderHospitalList(cluster) {
            currentCluster = cluster;
            const list = document.getElementById('hospitalList');
            const filtered = cluster === 'all' ? hospitals : hospitals.filter(h => h.cluster === cluster);
            
            list.innerHTML = filtered.map(hospital => {
                const data = currentData[hospital.id] || { urgent: 'Loading...', semiUrgent: 'Loading...', status: 'grey' };
                const dotClass = data.status;
                return `
                    <div class="hospital-item ${selectedHospital === hospital.id ? 'active' : ''}" 
                         data-id="${hospital.id}" onclick="selectHospital('${hospital.id}')">
                        <div class="hospital-info">
                            <div class="hospital-name">
                                <span class="status-dot ${dotClass}"></span>
                                ${hospital.name_en}
                            </div>
                            <div class="waiting-row">
                                <span class="waiting-label">Urgent (T3):</span>
                                <span class="waiting-time urgent">${data.urgent}</span>
                            </div>
                            <div class="waiting-row">
                                <span class="waiting-label">Semi-urgent (T4/5):</span>
                                <span class="waiting-time semi-urgent">${data.semiUrgent}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectHospital(id) {
            selectedHospital = id;
            const hospital = hospitals.find(h => h.id === id);
            if (!hospital) return;

            document.querySelectorAll('.hospital-item').forEach(item => {
                item.classList.toggle('active', item.dataset.id === id);
            });

            Object.values(markers).forEach(marker => {
                const isSelected = markers[id] === marker;
                marker.setIcon(L.divIcon({
                    className: 'hospital-marker',
                    html: isSelected ? 'üè•‚ú®' : 'üè•',
                    iconSize: isSelected ? [40, 40] : [32, 32],
                    iconAnchor: [20, 20]
                }));
            });

            updateInfoCard(hospital);
            map.flyTo([hospital.lat, hospital.lng], 15, { duration: 1 });
        }

        function updateInfoCard(hospital) {
            const data = currentData[hospital.id];
            if (!data) return;
            
            document.getElementById('infoTitle').textContent = hospital.name_en;
            document.getElementById('infoAddress').textContent = hospital.addr;
            document.getElementById('infoPhone').textContent = hospital.phone;
            document.getElementById('infoUrgent').textContent = data.urgent;
            document.getElementById('infoSemiUrgent').textContent = data.semiUrgent;
            document.getElementById('infoUpdateTime').textContent = data.updated;
            document.getElementById('infoCard').classList.add('active');
        }

        function setupEventListeners() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelector('.tab.active').classList.remove('active');
                    e.target.classList.add('active');
                    renderHospitalList(e.target.dataset.cluster);
                });
            });
        }

        // Close info card on map click
        document.addEventListener('DOMContentLoaded', function() {
            map.on('click', function(e) {
                if (selectedHospital) {
                    document.getElementById('infoCard').classList.remove('active');
                    selectedHospital = null;
                    Object.values(markers).forEach(marker => {
                        marker.setIcon(L.divIcon({
                            className: 'hospital-marker',
                            html: 'üè•',
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        }));
                    });
                    document.querySelectorAll('.hospital-item').forEach(item => {
                        item.classList.remove('active');
                    });
                }
            });
        });

        init();
    </script>
</body>
</html>
